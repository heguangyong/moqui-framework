<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>çº¯JWTè®¤è¯æµ‹è¯•</title>
    <script src="http://localhost:8080/libs/jquery/jquery.min.js"></script>
</head>
<body>
    <h1>çº¯JWTè®¤è¯æµ‹è¯•</h1>

    <div id="login-section">
        <h2>ç™»å½•</h2>
        <form id="jwt-login-form">
            <input type="text" id="username" value="john.doe" placeholder="ç”¨æˆ·å">
            <input type="password" id="password" value="moqui" placeholder="å¯†ç ">
            <button type="submit">JWTç™»å½•</button>
        </form>
    </div>

    <div id="test-section" style="display:none;">
        <h2>JWTæµ‹è¯•</h2>
        <button id="test-menu-data">æµ‹è¯•èœå•æ•°æ®</button>
        <button id="test-qapps-page">æµ‹è¯•qappsé¡µé¢</button>
        <div id="results"></div>
    </div>

    <script>
        // JWTå·¥å…·å‡½æ•°
        function getJwtToken() {
            return localStorage.getItem('jwt_access_token');
        }

        function setJwtToken(token) {
            localStorage.setItem('jwt_access_token', token);
        }

        function clearJwtToken() {
            localStorage.removeItem('jwt_access_token');
        }

        // ç™»å½•å¤„ç†
        $('#jwt-login-form').on('submit', function(e) {
            e.preventDefault();

            var username = $('#username').val();
            var password = $('#password').val();

            console.log('ğŸ” å¼€å§‹JWTç™»å½•æµ‹è¯•...');

            $.ajax({
                url: 'http://localhost:8080/Login/login',
                type: 'POST',
                data: {
                    username: username,
                    password: password
                },
                success: function(data, textStatus, jqXHR) {
                    console.log('ğŸ” ç™»å½•æˆåŠŸï¼Œæ£€æŸ¥JWTå“åº”å¤´...');

                    var authHeader = jqXHR.getResponseHeader('Authorization');
                    var accessToken = jqXHR.getResponseHeader('X-Access-Token');

                    if (authHeader && authHeader.startsWith('Bearer ')) {
                        accessToken = authHeader.substring(7);
                    }

                    if (accessToken) {
                        console.log('ğŸ” è·å¾—JWT token:', accessToken.substring(0, 20) + '...');
                        setJwtToken(accessToken);
                        $('#login-section').hide();
                        $('#test-section').show();
                        $('#results').html('<p style="color:green;">âœ… JWTç™»å½•æˆåŠŸï¼Tokenå·²ä¿å­˜ã€‚</p>');
                    } else {
                        $('#results').html('<p style="color:red;">âŒ æœªè·å¾—JWT token</p>');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('ğŸ” ç™»å½•å¤±è´¥:', errorThrown);
                    $('#results').html('<p style="color:red;">âŒ ç™»å½•å¤±è´¥: ' + errorThrown + '</p>');
                }
            });
        });

        // æµ‹è¯•èœå•æ•°æ®
        $('#test-menu-data').on('click', function() {
            var token = getJwtToken();
            if (!token) {
                $('#results').html('<p style="color:red;">âŒ æ²¡æœ‰JWT token</p>');
                return;
            }

            console.log('ğŸ” æµ‹è¯•èœå•æ•°æ®API...');

            $.ajax({
                url: 'http://localhost:8080/menuData/qapps',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    console.log('ğŸ” èœå•æ•°æ®è·å–æˆåŠŸ:', data);
                    $('#results').html('<p style="color:green;">âœ… JWTèœå•æ•°æ®è·å–æˆåŠŸï¼</p><pre>' + JSON.stringify(data, null, 2) + '</pre>');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('ğŸ” èœå•æ•°æ®è·å–å¤±è´¥:', errorThrown);
                    $('#results').html('<p style="color:red;">âŒ èœå•æ•°æ®è·å–å¤±è´¥: ' + errorThrown + ' (çŠ¶æ€ç : ' + jqXHR.status + ')</p>');
                }
            });
        });

        // æµ‹è¯•qappsé¡µé¢
        $('#test-qapps-page').on('click', function() {
            var token = getJwtToken();
            if (!token) {
                $('#results').html('<p style="color:red;">âŒ æ²¡æœ‰JWT token</p>');
                return;
            }

            console.log('ğŸ” æµ‹è¯•qappsé¡µé¢...');

            $.ajax({
                url: 'http://localhost:8080/qapps',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    console.log('ğŸ” qappsé¡µé¢è·å–æˆåŠŸ');
                    var hasAppList = data.indexOf('é€‰æ‹©åº”ç”¨') > -1;
                    var appCount = (data.match(/æ™ºèƒ½ä¾›éœ€å¹³å°|é¡¹ç›®æ‰§è¡Œ|é¡¹ç›®ç®¡ç†|å¯¹è±¡å­˜å‚¨/g) || []).length;
                    $('#results').html('<p style="color:green;">âœ… JWT qappsé¡µé¢è·å–æˆåŠŸï¼</p>' +
                                     '<p>åŒ…å«"é€‰æ‹©åº”ç”¨": ' + (hasAppList ? 'âœ…' : 'âŒ') + '</p>' +
                                     '<p>åº”ç”¨æ•°é‡: ' + appCount + '</p>');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('ğŸ” qappsé¡µé¢è·å–å¤±è´¥:', errorThrown);
                    $('#results').html('<p style="color:red;">âŒ qappsé¡µé¢è·å–å¤±è´¥: ' + errorThrown + ' (çŠ¶æ€ç : ' + jqXHR.status + ')</p>');
                }
            });
        });

        // æ£€æŸ¥ç°æœ‰token
        $(document).ready(function() {
            var existingToken = getJwtToken();
            if (existingToken) {
                console.log('ğŸ” å‘ç°ç°æœ‰JWT token:', existingToken.substring(0, 20) + '...');
                $('#login-section').hide();
                $('#test-section').show();
                $('#results').html('<p style="color:blue;">â„¹ï¸ å‘ç°ç°æœ‰JWT tokenï¼Œå¯ç›´æ¥æµ‹è¯•ã€‚</p>');
            }
        });
    </script>
</body>
</html>