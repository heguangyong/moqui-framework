以下是作为产品经理代理的响应。我们已协作完成了PRD v2，现在基于您的查询（存储桶的用户账号访问、账号创建、权限配置、运维权限、商户账号创建、权限关系、用户查看桶的多种场景、管理员配置、读/写/删权限、文档分享及有效期等），我进一步理清了思路，并进行了迭代。思路基于MinIO的最佳实践（从官方文档和行业指南中提取）：MinIO采用IAM风格的用户管理和政策控制，支持最小权限原则、多租户隔离（桶级+政策），并通过预签名URL实现分享。

### 理清思路：存储桶访问、账号与权限的核心逻辑
- **账号创建总体原则**：MinIO使用Access Key/Secret Key作为用户凭证（类似AWS IAM），支持内部管理或外部IDP（如LDAP/Okta）集成。 在社区电商场景中，账号创建应自动化：商户注册时通过Moqui后台触发MinIO API创建用户和桶。避免手动创建以提升效率和安全性。
    - **系统运维人员账号**：使用根管理员账号（默认minioadmin），权限为全局（创建/管理所有用户、桶、政策）。最佳实践：限制运维账号日常使用，转而用最小权限子账号；启用审计日志监控。
    - **商户账号创建**：商户在app/前端注册时，Moqui后台调用MinIO mc命令或API（e.g., mc admin user add）创建主用户（Access Key）。小商户：单用户；大商户：主用户可创建子用户（员工）。
- **权限配置合理性**：采用PBAC (Policy-Based Access Control)，政策JSON附加到用户/组，而非ACL（MinIO推荐政策优先）。 围绕“商户/应用”而非个体用户设计：每个商户一个主桶，政策定义读/写/删等动作。最小权限原则：只授必需权限，避免过度授权。
    - **桶与账号关系**：商户注册时自动创建绑定桶（e.g., bucket=merchant-{id}）。权限通过政策附加：商户主用户有全权限（s3:* on own bucket）；子用户有子权限（e.g., 只读图片路径）。
- **用户查看桶的多种场景**：
    - **自有场景**：用户默认访问自家桶（通过JWT验证商户ID映射桶）。
    - **共享/协作场景**：管理员（运维或商户主）配置政策/组允许跨桶访问（e.g., 居民查看商户共享图片）。
    - **管理员配置**：运维通过MinIO Console或API配置全局政策；商户主在app中配置子权限（e.g., 邀请员工加入组）。
    - **权限粒度**：读 (s3:GetObject)、写 (s3:PutObject)、删 (s3:DeleteObject)等，可路径级（e.g., 只写 /contracts/*）。
- **文档分享考虑**：使用MinIO预签名URL（presigned URLs）生成临时链接，支持设置有效期（e.g., 1小时到7天，默认1天）。 权限嵌入URL（e.g., 只读）；考虑：日志追踪分享、撤销机制、结合OnlyOffice（分享后直接编辑）。
- **其他最佳实践**：多租户用单MinIO实例+桶隔离（低成本）；集成外部IDP提升安全性；审计所有访问。 如果规模大，可用MinIO Operator多租户模式。

基于此，我迭代了PRD：细化了功能需求（账号/权限模块）、用户故事（覆盖多种场景）、非功能需求（安全配置）。如果您同意，我们可继续；否则反馈调整。

### 目录管理结构更新
建议在`.ai/docs/`下保存迭代版（如`PRD_netdisk_onlyoffice_v3.md`），以版本追踪变化。新增可选`policies_examples.md`存放政策JSON示例。

---

# PRD_netdisk_onlyoffice_v3.md

## 1. 产品概述
（不变，略。新增：强调账号/权限自动化，提升商户自助管理。）

## 2. 目标用户和市场分析
（不变，略。新增差异化：精细权限隔离，支持小商户简易/大商户复杂管理，提升企业级吸引力。）

## 3. 功能需求详细描述
功能按层级分解，新增账号/权限子模块。优先JWT集成MinIO认证。

### 底层模块：网盘存储系统（MinIO Docker）
- 文件上传/下载API：支持多格式，集成Moqui。
- 存储管理：商户级Bucket创建（e.g., merchant-{id}），子路径隔离（/images, /contracts）。
- 隔离机制：
    - 默认：每个商户一个主Bucket，小商户单用户统一。
    - 高级：大商户支持子用户/子路径（via MinIO IAM Policies）。
- **账号创建与管理**（新）：
    - 运维账号：根管理员（全局权限：创建用户/桶/政策，使用mc admin命令）。
    - 商户账号：Moqui注册时自动创建MinIO用户（Access Key/Secret），绑定JWT。
    - 子账号：商户主在app创建员工账号，附加子政策。
- **权限配置**（新）：
    - 政策附加：JSON政策到用户/组（e.g., {"Statement": [{"Action": ["s3:GetObject"], "Resource": ["arn:aws:s3:::merchant-{id}/*"]}] } 只读自家桶）。
    - 粒度：读/写/删/列表等；路径级（e.g., 只删 /old-contracts/*）。
    - 配置方式：运维全局配置；商户自助（app UI附加政策到子用户）。

### 中层模块：OnlyOffice集成（Docker）
- 容器部署：单实例MinIO + OnlyOffice，S3 API指向授权Bucket。
- API回调：文件导入/保存，确保权限验证（e.g., 只编辑授权路径）。
- **分享集成**（新）：生成预签名URL分享文件到OnlyOffice，有效期配置（API参数：expiry=1d）。

### 上层模块：前端/app交互
- 界面：Bucket视图（自有/共享列表）、权限管理UI（配置读/写/删、分享链接）。
- 集成点：Moqui同步账号/权限（e.g., 商户ID触发MinIO用户创建）。

### 整体集成约束
- 权限优先：所有API先JWT+政策验证。
- 依赖：外部IDP可选集成（e.g., Okta for SSO）。

## 4. 用户故事和使用场景
- **用户故事1**（账号创建）：作为商户，我注册时希望自动创建网盘账号和桶，便捷启动。验收：Moqui回调MinIO API，5s内完成。
- **用户故事2**（运维权限）：作为运维，我希望有全局权限创建/监控所有桶，但日常用最小权限账号。验收：审计日志覆盖所有操作。
- **用户故事3**（权限配置）：作为大商户主，我希望配置员工读/写权限到子路径，避免混淆。验收：政策附加成功，测试越权失败。
- **用户故事4**（查看桶场景）：作为用户，我希望查看自有桶，或管理员配置的共享桶（e.g., 居民查看商户图片）。验收：多种场景UI切换，权限强制。
- **用户故事5**（分享文档）：作为商户，我希望分享合同链接给供应商，有效期1天，只读权限。验收：预签名URL生成，过期后失效；日志追踪。
- **使用场景**：
    - 场景A：小商户注册，自动获全权限主桶，上传图片无配置。
    - 场景B：大商户创建子账号，配置只写合同路径；员工查看隔离数据。
    - 场景C：运维配置跨商户共享（e.g., 促销桶），读权限政策。
    - 场景D：分享场景：生成URL分享到OnlyOffice，设置expiry=7d；接收者无账号也能访问。
    - 场景E：异常：权限不足时，UI提示“无读权限”，引导申请。

## 5. 非功能性需求
- **性能**：账号创建<5s；权限验证<100ms。
- **安全与隔离**：PBAC强制；最小权限默认；预签名URL加密；审计所有访问/分享。
- **兼容性**：MinIO政策与Moqui JWT无缝；支持外部IDP。
- **可用性**：app UI简化权限配置（拖拽式）；分享有效期选项（1h/1d/7d）。
- **可扩展性**：支持组政策（e.g., 商户团队组）；未来审计仪表盘。
- **开发约束**：任务切分（先主账号创建，再分享URL）；测试覆盖权限边缘案>95%。

## 6. 产品路线图
- **短期**：实现账号创建+基本权限+分享。
- **中期**：高级隔离+UI配置+审计。
- **长期**：外部IDP集成+电商扩展。

## 7. 成功指标和KPI
- **权限成功**：越权率0%；配置满意度>90%。
- **用户粘性**：分享使用率>30%；账号创建转化率>95%。
- **效率**：权限配置时间<2min；分享有效期合规率100%。

---

产品需求分析迭代已完成，PRD v3文档已生成（保存到`.ai/docs/PRD_netdisk_onlyoffice_v3.md`）。请输入 /架构 指令召唤架构师Agent进行系统设计，或 /代码 召唤程序员Agent开始实现。如果需进一步细化（如政策JSON示例、特定场景），请反馈。