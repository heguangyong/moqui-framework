# 软删除设计方案

**Spec**: 08-02-auth-diagnosis-fix  
**设计时间**: 2026-01-24  
**设计者**: Kiro AI

---

## 🎯 设计决策

### 选择：软删除 + 回收站机制

**理由**:
1. ✅ **数据安全** - 防止误删除，数据可恢复
2. ✅ **审计追踪** - 保留完整的删除历史
3. ✅ **用户体验** - 类似 Windows/macOS 回收站，用户熟悉
4. ✅ **合规要求** - 满足数据保留和审计要求
5. ✅ **灵活性** - 可以选择永久删除或自动清理

---

## 📊 功能设计

### 1. 项目状态管理

**状态字段**: `status`

| 状态值 | 说明 | 显示位置 |
|--------|------|----------|
| `active` | 活跃项目 | 项目列表 |
| `completed` | 已完成 | 项目列表 |
| `deleted` | 已删除 | 回收站 |
| `permanently_deleted` | 永久删除 | 不显示 |

### 2. 删除时间戳

**新增字段**: `deletedDate`
- 记录删除时间
- 用于自动清理（30天后）
- 用于显示"删除于X天前"

### 3. 用户界面

#### 主界面（项目列表）
- ✅ 只显示 `status != 'deleted'` 的项目
- ✅ 删除按钮 → 移到回收站

#### 回收站界面
- ✅ 显示 `status = 'deleted'` 的项目
- ✅ 恢复按钮 → 恢复到活跃状态
- ✅ 永久删除按钮 → 真正删除（可选）
- ✅ 显示删除时间
- ✅ 清空回收站按钮

---

## 🔧 实现方案

### 后端服务

#### 1. 删除项目（移到回收站）✅ 已实现

```groovy
// 软删除：更新状态
projectEntity.status = "deleted"
projectEntity.deletedDate = ec.user.nowTimestamp
projectEntity.update()
```

#### 2. 获取项目列表 ✅ 已实现

```groovy
// 排除已删除的项目
.condition("status", "!=", "deleted")
```

#### 3. 获取回收站项目（新增）

```groovy
// 只查询已删除的项目
.condition("status", "=", "deleted")
.orderBy("deletedDate DESC")
```

#### 4. 恢复项目（新增）

```groovy
// 恢复：更新状态为 active
projectEntity.status = "active"
projectEntity.deletedDate = null
projectEntity.update()
```

#### 5. 永久删除（可选）

```groovy
// 真正删除记录
projectEntity.delete()
```

#### 6. 自动清理（可选）

```groovy
// 删除30天前的项目
def thirtyDaysAgo = new Date() - 30
.condition("status", "=", "deleted")
.condition("deletedDate", "<", thirtyDaysAgo)
.deleteAll()
```

---

## 📋 实施计划

### 阶段 1: 核心功能（当前）✅

- [x] 软删除实现
- [x] 项目列表过滤已删除项目
- [x] 删除权限修复

### 阶段 2: 回收站功能（推荐）

- [ ] 添加 `deletedDate` 字段到实体
- [ ] 创建"获取回收站项目"服务
- [ ] 创建"恢复项目"服务
- [ ] 前端添加回收站视图
- [ ] 前端添加恢复按钮

### 阶段 3: 高级功能（可选）

- [ ] 永久删除功能
- [ ] 清空回收站功能
- [ ] 自动清理定时任务（30天）
- [ ] 批量操作（批量恢复/删除）

---

## 🎨 用户界面设计

### 主界面

```
┌─────────────────────────────────────┐
│ 我的项目                    [回收站] │
├─────────────────────────────────────┤
│ □ test-novel-1        [编辑] [删除] │
│ □ test-novel-2        [编辑] [删除] │
│ □ my-project          [编辑] [删除] │
└─────────────────────────────────────┘
```

### 回收站界面

```
┌─────────────────────────────────────┐
│ 回收站                      [清空]   │
├─────────────────────────────────────┤
│ □ deleted-project-1   [恢复] [永久删除] │
│   删除于 2天前                        │
│ □ deleted-project-2   [恢复] [永久删除] │
│   删除于 5天前                        │
└─────────────────────────────────────┘
```

---

## 🔧 立即实施（阶段 2）

让我现在实现回收站的核心功能：

### 1. 添加 deletedDate 字段

**文件**: `runtime/component/novel-anime-generator/entity/NovelAnimeEntities.xml`

```xml
<field name="deletedDate" type="date-time"/>
```

### 2. 创建回收站服务

**文件**: `runtime/component/novel-anime-generator/service/novel/anime/TestServices.xml`

```groovy
// 获取回收站项目
service verb="get" noun="DeletedProjects"

// 恢复项目
service verb="restore" noun="Project"
```

### 3. 前端回收站视图

**文件**: `frontend/NovelAnimeDesktop/src/renderer/views/RecycleBin.vue`

---

## 💡 最佳实践

### 1. 用户提示

删除时显示提示：
```
"项目已移到回收站，可以在回收站中恢复"
```

### 2. 自动清理通知

30天前发送通知：
```
"回收站中的项目将在X天后永久删除"
```

### 3. 权限控制

- 删除 → 移到回收站：所有用户
- 恢复 → 从回收站恢复：所有用户
- 永久删除 → 真正删除：管理员或项目所有者

---

## 🎯 推荐配置

### 当前配置（已实施）

```
✅ 软删除：status = "deleted"
✅ 列表过滤：不显示已删除项目
✅ 删除权限：已修复
```

### 推荐添加（阶段 2）

```
⏳ 回收站视图：查看已删除项目
⏳ 恢复功能：一键恢复
⏳ 删除时间：显示删除时间
```

### 可选功能（阶段 3）

```
⏭️ 永久删除：彻底删除
⏭️ 自动清理：30天后自动删除
⏭️ 批量操作：批量恢复/删除
```

---

## 📊 对比：软删除 vs 硬删除

| 特性 | 软删除 | 硬删除 |
|------|--------|--------|
| 数据安全 | ✅ 高 | ❌ 低 |
| 可恢复性 | ✅ 可恢复 | ❌ 不可恢复 |
| 存储空间 | ⚠️ 占用空间 | ✅ 释放空间 |
| 审计追踪 | ✅ 完整 | ❌ 无 |
| 实现复杂度 | ⚠️ 中等 | ✅ 简单 |
| 用户体验 | ✅ 好 | ⚠️ 一般 |

**结论**: 软删除更适合生产环境

---

## 🚀 下一步行动

### 立即可用（无需修改）

当前实现已经可以正常使用：
- ✅ 删除功能正常
- ✅ 已删除项目不显示
- ✅ 数据保留在数据库

### 如果需要回收站功能

我可以立即实现：
1. 添加 `deletedDate` 字段
2. 创建回收站服务
3. 创建前端回收站视图
4. 添加恢复功能

**是否需要我现在实现回收站功能？**

---

## 📝 总结

**当前状态**: ✅ 软删除已实现，功能正常

**推荐方案**: 
1. ✅ 保持当前软删除实现
2. ⏳ 添加回收站功能（推荐）
3. ⏭️ 添加自动清理（可选）

**用户体验**:
- 删除 → 项目从列表消失（移到回收站）
- 数据 → 保留在数据库，可以恢复
- 安全 → 防止误删除

**Ultrawork 精神**: 不仅解决问题，还提供完整的解决方案！🔥

