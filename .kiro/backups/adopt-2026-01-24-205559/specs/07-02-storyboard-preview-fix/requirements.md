# 分镜头预览图片显示修复 - 需求文档

## 1. 项目概述

### 1.1 项目背景
用户在"分镜头预览"页面看到所有分镜的图片都显示为破损图标（🖼️），无法正常显示图片。这是一个关键的用户体验问题，影响了工作流执行结果的可视化展示。

### 1.2 问题描述
从用户提供的截图可以看到：
- 页面标题：**分镜头预览**
- 主内容区显示"分镜头 1 (1/5)"
- **图片区域显示破损图标** - 核心问题
- 右侧分镜列表显示5个分镜，但缩略图都是破损图标
- 控制台显示正常的路由和登录日志

### 1.3 根本原因
在 `frontend/NovelAnimeDesktop/src/renderer/views/PreviewView.vue` 文件中：

1. **使用了硬编码的占位符路径**
   - `imageUrl: '/placeholder-storyboard-1.jpg'` - 这些文件不存在
   - `thumbnailUrl: '/placeholder-thumb-1.jpg'` - 这些文件不存在

2. **没有从工作流结果加载真实数据**
   - `loadPreviewData()` 函数只返回模拟数据
   - 没有从 `navigationStore.workflowState.executionResult` 获取数据
   - 没有处理真实的图片URL

3. **图片加载逻辑问题**
   - 因为 `imageUrl` 指向不存在的文件，触发 `@error` 事件
   - 显示破损图标

## 2. 用户故事

### 2.1 作为用户
**作为** 小说动画生成系统的用户  
**我想要** 在"分镜头预览"页面看到工作流生成的分镜图片  
**以便** 我可以直观地查看和评估生成的分镜内容

**验收标准**:
- ✅ 页面能够从工作流执行结果中加载分镜数据
- ✅ 如果有图片URL，能够正确显示图片
- ✅ 如果没有图片URL，显示友好的占位符
- ✅ 缩略图列表能够正确显示
- ✅ 如果没有数据，显示友好的空状态提示

### 2.2 作为开发者
**作为** 系统开发者  
**我想要** 确保数据流从工作流执行到预览页面是完整的  
**以便** 用户能够看到他们生成的内容

**验收标准**:
- ✅ 工作流执行结果正确存储在 navigationStore
- ✅ PreviewView 能够正确读取和解析执行结果
- ✅ 支持多种数据格式（scenes, storyboards, scripts）
- ✅ 有详细的日志输出便于调试

## 3. 功能需求

### 3.1 数据加载 (FR-1)
**优先级**: P0 (核心功能)

**需求描述**:
- 从 `navigationStore.workflowState.executionResult` 加载工作流执行结果
- 解析 `nodeResultsData` 或 `nodeResults` 中的数据
- 提取 `scenes` 和 `storyboards` 数据
- 如果没有 `storyboards`，尝试从 `scripts` 转换

**验收标准**:
1. 能够正确读取工作流执行结果
2. 能够处理多种数据格式
3. 能够提取场景和分镜数据
4. 有详细的日志输出

### 3.2 图片显示 (FR-2)
**优先级**: P0 (核心功能)

**需求描述**:
- 使用真实的图片URL：`storyboard.imageUrl || storyboard.image || undefined`
- 使用真实的缩略图URL：`storyboard.thumbnailUrl || storyboard.thumbnail || undefined`
- 如果没有图片URL，显示占位符图标
- 处理图片加载失败的情况

**验收标准**:
1. 如果有图片URL，能够正确显示图片
2. 如果没有图片URL，显示友好的占位符
3. 图片加载失败时，显示错误提示
4. 缩略图列表能够正确显示

### 3.3 空状态处理 (FR-3)
**优先级**: P1 (重要功能)

**需求描述**:
- 如果没有工作流执行结果，显示空状态
- 提示用户"请先执行工作流生成内容"
- 提供友好的图标和文案

**验收标准**:
1. 没有数据时显示空状态
2. 空状态有友好的图标和文案
3. 提示用户如何生成内容

### 3.4 错误处理 (FR-4)
**优先级**: P1 (重要功能)

**需求描述**:
- 捕获数据加载错误
- 捕获图片加载错误
- 显示友好的错误提示
- 记录详细的错误日志

**验收标准**:
1. 数据加载错误时显示提示
2. 图片加载错误时显示提示
3. 错误日志详细且易于调试

## 4. 非功能需求

### 4.1 性能需求 (NFR-1)
- 数据加载时间 < 500ms
- 图片加载时间 < 2s
- 页面响应时间 < 100ms

### 4.2 可用性需求 (NFR-2)
- 界面友好，符合系统整体风格
- 错误提示清晰易懂
- 空状态提示有指导性

### 4.3 可维护性需求 (NFR-3)
- 代码结构清晰
- 日志输出详细
- 易于调试和扩展

### 4.4 兼容性需求 (NFR-4)
- 支持多种数据格式
- 支持多种图片URL格式（本地文件、网络URL、Base64）
- 兼容不同的工作流节点输出

## 5. 约束条件

### 5.1 技术约束
- 使用 Vue 3 Composition API
- 使用 Pinia 状态管理
- 使用 TypeScript
- 遵循项目代码规范

### 5.2 业务约束
- 不能破坏现有功能
- 必须保持向后兼容
- 必须通过端到端测试

### 5.3 时间约束
- 修复必须在下一个版本发布前完成
- 测试必须覆盖所有场景

## 6. 依赖关系

### 6.1 前置依赖
- 工作流执行功能正常
- navigationStore 正确存储执行结果
- 后端服务正常运行

### 6.2 后置依赖
- 图片生成功能（如果需要）
- 导出功能（依赖预览数据）

## 7. 风险评估

### 7.1 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 数据格式不一致 | 高 | 中 | 支持多种格式，详细日志 |
| 图片加载失败 | 中 | 高 | 友好的错误处理 |
| 性能问题 | 低 | 低 | 优化加载逻辑 |

### 7.2 业务风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 用户体验下降 | 高 | 低 | 充分测试 |
| 功能回归 | 中 | 低 | 自动化测试 |

## 8. 成功标准

### 8.1 功能完整性
- ✅ 所有功能需求已实现
- ✅ 所有验收标准已满足
- ✅ 所有测试用例已通过

### 8.2 质量标准
- ✅ 代码审查通过
- ✅ 性能测试通过
- ✅ 用户验收测试通过

### 8.3 文档完整性
- ✅ 技术文档已更新
- ✅ 用户文档已更新
- ✅ 测试文档已完成

## 9. 验收测试场景

### 9.1 正常场景
1. **场景**: 工作流执行成功，生成了分镜数据和图片
   - **前置条件**: 工作流已执行，生成了分镜数据
   - **操作步骤**: 导航到"分镜头预览"页面
   - **预期结果**: 显示分镜图片和描述

2. **场景**: 工作流执行成功，但没有生成图片
   - **前置条件**: 工作流已执行，但没有图片URL
   - **操作步骤**: 导航到"分镜头预览"页面
   - **预期结果**: 显示占位符图标和描述

### 9.2 异常场景
1. **场景**: 没有执行工作流
   - **前置条件**: 没有工作流执行结果
   - **操作步骤**: 导航到"分镜头预览"页面
   - **预期结果**: 显示空状态，提示用户执行工作流

2. **场景**: 图片URL无效
   - **前置条件**: 工作流返回了无效的图片URL
   - **操作步骤**: 导航到"分镜头预览"页面
   - **预期结果**: 显示错误提示，记录错误日志

3. **场景**: 数据格式错误
   - **前置条件**: 工作流返回了错误格式的数据
   - **操作步骤**: 导航到"分镜头预览"页面
   - **预期结果**: 显示错误提示，记录详细日志

## 10. 附录

### 10.1 相关文档
- `STORYBOARD_IMAGE_FIX.md` - 问题分析和修复文档
- `WORKFLOW_DATA_FLOW_FIX_APPLIED.md` - 工作流数据流修复文档
- `frontend/NovelAnimeDesktop/src/renderer/views/PreviewView.vue` - 预览页面组件

### 10.2 术语表
- **分镜头**: 动画制作中的关键帧，描述场景的视觉效果
- **工作流**: 自动化的处理流程，包含多个节点
- **节点结果**: 工作流节点执行后的输出数据
- **navigationStore**: 导航状态管理器，存储工作流执行结果

---

**文档版本**: v1.0  
**创建日期**: 2025-01-19  
**最后更新**: 2025-01-19  
**作者**: Kiro Team
