<!DOCTYPE html>
<html>
<head>
    <title>Moqui JWT å®Œæ•´ç™»å½•è§£å†³æ–¹æ¡ˆ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        #status { min-height: 100px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ” Moqui JWT å®Œæ•´ç™»å½•è§£å†³æ–¹æ¡ˆ</h1>

    <div class="step">
        <h3>æ­¥éª¤ 1: è‡ªåŠ¨è·å–JWTè®¤è¯</h3>
        <button onclick="autoLogin()">ğŸš€ è‡ªåŠ¨ç™»å½•å¹¶æ³¨å…¥JWT</button>
        <p>ç‚¹å‡»æ­¤æŒ‰é’®å°†è‡ªåŠ¨å®Œæˆç™»å½•å¹¶æ³¨å…¥JWTä»¤ç‰Œåˆ°æµè§ˆå™¨</p>
    </div>

    <div class="step">
        <h3>æ­¥éª¤ 2: éªŒè¯APIè®¿é—®</h3>
        <button onclick="testAPI()">ğŸ§ª æµ‹è¯•APIè¿æ¥</button>
        <p>éªŒè¯JWTè®¤è¯æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
    </div>

    <div class="step">
        <h3>æ­¥éª¤ 3: æ‰“å¼€Moquiåº”ç”¨</h3>
        <button onclick="openMoqui()">ğŸ“± æ‰“å¼€Moquiåº”ç”¨</button>
        <p>åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€Moquiåº”ç”¨ç•Œé¢</p>
    </div>

    <div class="step">
        <h3>æ­¥éª¤ 4: ç›´æ¥è®¿é—®é“¾æ¥</h3>
        <a href="http://localhost:8080/qapps" target="_blank" style="color: #007bff; text-decoration: none;">
            ğŸ”— ç›´æ¥è®¿é—® http://localhost:8080/qapps
        </a>
        <p>å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œæ‚¨å¯ä»¥ç›´æ¥è®¿é—®æ­¤é“¾æ¥</p>
    </div>

    <div id="status"></div>

    <script>
    function log(message, isError = false) {
        const status = document.getElementById('status');
        const timestamp = new Date().toLocaleTimeString();
        const className = isError ? 'error' : 'success';
        status.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        status.scrollTop = status.scrollHeight;
    }

    async function autoLogin() {
        try {
            log('ğŸ” å¼€å§‹è‡ªåŠ¨ç™»å½•æµç¨‹...');

            // Step 1: è·å–JWT token
            const loginResponse = await fetch('http://localhost:8080/rest/s1/moqui/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'john.doe', password: 'moqui' })
            });

            if (!loginResponse.ok) {
                throw new Error(`ç™»å½•è¯·æ±‚å¤±è´¥: ${loginResponse.status}`);
            }

            const loginData = await loginResponse.json();
            log(`âœ… æˆåŠŸè·å–JWT Token: ${loginData.accessToken.substring(0, 30)}...`);

            // Step 2: å­˜å‚¨tokenåˆ°æ‰€æœ‰å¯èƒ½çš„ä½ç½®
            localStorage.setItem('jwt_access_token', loginData.accessToken);
            localStorage.setItem('jwt_refresh_token', loginData.refreshToken || '');
            sessionStorage.setItem('jwt_access_token', loginData.accessToken);

            // è®¾ç½®cookie
            document.cookie = `jwt_access_token=${loginData.accessToken}; path=/; max-age=7200; SameSite=Lax`;

            log('âœ… JWT tokenså·²å­˜å‚¨åˆ° localStorage, sessionStorage å’Œ cookie');

            // Step 3: æµ‹è¯•APIè®¿é—®
            const testResponse = await fetch('http://localhost:8080/qapps/menuData', {
                headers: { 'Authorization': `Bearer ${loginData.accessToken}` }
            });

            if (testResponse.ok) {
                const menuData = await testResponse.json();
                log(`âœ… APIæµ‹è¯•æˆåŠŸ - è·å–åˆ° ${menuData.length} ä¸ªèœå•é¡¹`);
                log('ğŸ‰ JWTè®¤è¯è®¾ç½®å®Œæˆï¼ç°åœ¨å¯ä»¥è®¿é—®Moquiåº”ç”¨äº†');
            } else {
                log(`âš ï¸ APIæµ‹è¯•å¤±è´¥: ${testResponse.status}`, true);
            }

        } catch (error) {
            log(`âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥: ${error.message}`, true);
        }
    }

    async function testAPI() {
        try {
            const token = localStorage.getItem('jwt_access_token');
            if (!token) {
                log('âŒ æœªæ‰¾åˆ°JWT tokenï¼Œè¯·å…ˆæ‰§è¡Œè‡ªåŠ¨ç™»å½•', true);
                return;
            }

            log('ğŸ§ª æµ‹è¯•APIè¿æ¥...');

            const response = await fetch('http://localhost:8080/qapps/menuData', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                log(`âœ… APIè¿æ¥æˆåŠŸ - çŠ¶æ€ç : ${response.status}, èœå•æ•°é‡: ${data.length}`);
            } else {
                log(`âŒ APIè¿æ¥å¤±è´¥ - çŠ¶æ€ç : ${response.status}`, true);
            }

        } catch (error) {
            log(`âŒ APIæµ‹è¯•é”™è¯¯: ${error.message}`, true);
        }
    }

    function openMoqui() {
        const token = localStorage.getItem('jwt_access_token');
        if (!token) {
            log('âŒ æœªæ‰¾åˆ°JWT tokenï¼Œè¯·å…ˆæ‰§è¡Œè‡ªåŠ¨ç™»å½•', true);
            return;
        }

        log('ğŸ“± æ­£åœ¨æ‰“å¼€Moquiåº”ç”¨...');

        // åˆ›å»ºä¸€ä¸ªå¸¦æœ‰JWTè®¾ç½®çš„æ–°çª—å£
        const moquiWindow = window.open('', '_blank');

        // æ³¨å…¥JWT tokenåˆ°æ–°çª—å£
        moquiWindow.document.write(`
            <html>
            <head><title>Loading Moqui...</title></head>
            <body>
                <div style="text-align:center; margin-top:100px; font-family:Arial;">
                    <h2>ğŸ” æ­£åœ¨è®¾ç½®JWTè®¤è¯...</h2>
                    <p>å³å°†è·³è½¬åˆ°Moquiåº”ç”¨</p>
                </div>
                <script>
                    localStorage.setItem('jwt_access_token', '${token}');
                    sessionStorage.setItem('jwt_access_token', '${token}');
                    document.cookie = 'jwt_access_token=${token}; path=/; max-age=7200';
                    setTimeout(() => {
                        window.location.href = 'http://localhost:8080/qapps';
                    }, 2000);
                </script>
            </body>
            </html>
        `);

        log('âœ… å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€Moquiåº”ç”¨');
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥JWTçŠ¶æ€
    window.onload = function() {
        const token = localStorage.getItem('jwt_access_token');
        if (token) {
            log('ğŸ“‹ æ£€æµ‹åˆ°å·²å­˜å‚¨çš„JWT token');
            log('âœ… æ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡» "æ‰“å¼€Moquiåº”ç”¨" æˆ–è®¿é—®é“¾æ¥');
        } else {
            log('ğŸ“‹ æœªæ£€æµ‹åˆ°JWT tokenï¼Œè¯·å…ˆæ‰§è¡Œè‡ªåŠ¨ç™»å½•');
        }
    }
    </script>
</body>
</html>