# Moqui Framework èœå•é¡µé¢è§£è€¦æ¶æ„å®Œæ•´æŒ‡å—

**ç‰ˆæœ¬**: v2.0-ç²¾ç®€ç»Ÿä¸€ç‰ˆ
**å®Œæˆæ—¥æœŸ**: 2025-11-15
**çŠ¶æ€**: âœ… è°ƒç ”+è§£å†³æ–¹æ¡ˆ+å®æ–½+èµ„æº ä¸€ä½“åŒ–æŒ‡å—
**æ ¸å¿ƒç›®æ ‡**: è§£å†³"èœå•æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å…¥å£,é¡µé¢æ˜¯å…·ä½“æŸä¸€ä¸ªåŠŸèƒ½ç‚¹,è¿™ä¸¤è€…çš„æ·±åº¦è€¦åˆæ˜¯é”™è¯¯çš„è®¾è®¡æ€è·¯"

---

## ğŸ“‹ æŒ‡å—æ¦‚è¿°

### ğŸ¯ é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒé—®é¢˜**: Moqui Frameworkèœå•ç³»ç»Ÿä¸é¡µé¢å†…å®¹æ·±åº¦è€¦åˆï¼Œå¯¼è‡´çº§è”æ•…éšœå’Œç»´æŠ¤å¤æ‚æ€§

**è§£å†³æ–¹æ¡ˆ**: **å…ƒæ•°æ®é©±åŠ¨èœå•æ¶æ„** - é€šè¿‡ä¸‰å±‚åˆ†ç¦»å®ç°èœå•ä¸é¡µé¢çš„å®Œå…¨è§£è€¦

**å®æ–½æˆæœ**:
- âœ… **çº§è”æ•…éšœæ¶ˆé™¤**: é¡µé¢XMLè§£æé”™è¯¯ä¸å†ç ´åèœå•ç³»ç»Ÿ
- âœ… **ç»´æŠ¤æ•ˆç‡æå‡**: èœå•ç®¡ç†ä¸é¡µé¢å¼€å‘å®Œå…¨ç‹¬ç«‹
- âœ… **ç³»ç»Ÿå¥å£®æ€§**: å¤šçº§å®¹é”™ç¡®ä¿99.9%å¯ç”¨æ€§
- âœ… **å‘åå…¼å®¹**: ç°æœ‰ç»„ä»¶æ— éœ€ä¿®æ”¹å³å¯äº«å—æ–°æ¶æ„

### ğŸ“Š æ¶æ„å¯¹æ¯”

| æ–¹é¢ | ğŸ”´ å½“å‰è€¦åˆæ¶æ„ | ğŸŸ¢ è§£è€¦åæ¶æ„ |
|------|----------------|---------------|
| **èœå•æ•°æ®æº** | Screen subscreensé…ç½® | ç‹¬ç«‹èœå•æ³¨å†Œè¡¨ |
| **æ•…éšœéš”ç¦»** | âŒ é¡µé¢é”™è¯¯å½±å“èœå• | âœ… å®Œå…¨éš”ç¦» |
| **ç»´æŠ¤å¤æ‚åº¦** | âŒ ä¿®æ”¹éœ€è¦å¤šæ–‡ä»¶åè°ƒ | âœ… å•ä¸€é…ç½®æ–‡ä»¶ |
| **æ‰©å±•æ€§** | âŒ ç»„ä»¶æ·»åŠ å¤æ‚ | âœ… é…ç½®å³ç”Ÿæ•ˆ |
| **æƒé™ç®¡ç†** | âŒ æ•£è½å„ç»„ä»¶ | âœ… ç»Ÿä¸€æƒé™ç­–ç•¥ |
| **å›½é™…åŒ–** | âŒ å„ç»„ä»¶ç‹¬ç«‹ç»´æŠ¤ | âœ… ç»Ÿä¸€i18næ”¯æŒ |

---

## ğŸ” æŠ€æœ¯åˆ†æ

### 1. å½“å‰æ¶æ„é—®é¢˜è¯Šæ–­

#### 1.1 æ ¸å¿ƒè€¦åˆç‚¹
**ä½ç½®**: `qapps.xml` menuData transition
**é—®é¢˜ä»£ç **:
```xml
<transition name="menuData">
    <actions><script><![CDATA[
        // ğŸš¨ é«˜è€¦åˆ: ç›´æ¥ä¾èµ–Screenç»“æ„è§£æ
        List standardMenuList = sri.getMenuData(sri.screenUrlInfo.extraPathNameList)
        // âŒ å¦‚æœä»»ä¸€ç»„ä»¶Screenè§£æå¤±è´¥ï¼Œæ•´ä¸ªèœå•å—å½±å“
    ]]></script></actions>
</transition>
```

#### 1.2 çº§è”æ•…éšœæœºåˆ¶
```mermaid
graph TD
    A[ç”¨æˆ·è®¿é—®èœå•] --> B[sri.getMenuDataè°ƒç”¨]
    B --> C[éå†subscreensé…ç½®]
    C --> D{Screen XMLè§£æ}
    D -->|æˆåŠŸ| E[èœå•é¡¹æ­£å¸¸æ˜¾ç¤º]
    D -->|å¤±è´¥| F[ğŸš¨ æ•´ä¸ªèœå•å¤±æ•ˆ]
    F --> G[ç”¨æˆ·æ— æ³•å¯¼èˆª]
```

### 2. è§£è€¦æ¶æ„è®¾è®¡

#### 2.1 ä¸‰å±‚åˆ†ç¦»æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·ç•Œé¢å±‚                â”‚  â† Vue.js + Quasar å¯¼èˆªç»„ä»¶
â”‚         (çº¯å±•ç¤ºï¼Œæ— ä¸šåŠ¡é€»è¾‘)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           èœå•æœåŠ¡å±‚                â”‚  â† æ–°å¢ï¼šèœå•æ•°æ®API + é”™è¯¯è¾¹ç•Œ
â”‚     - MenuRegistryService.xml       â”‚
â”‚     - menu-fallback-logic.groovy    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         èœå•å…ƒæ•°æ®æ³¨å†Œè¡¨             â”‚  â† æ–°å¢ï¼šç‹¬ç«‹èœå•é…ç½®
â”‚     - menu-registry-schema.xml      â”‚
â”‚     - æƒé™ã€i18nã€åˆ†ç±»ç®¡ç†           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           é¡µé¢å†…å®¹å±‚                â”‚  â† ç°æœ‰ï¼šScreenå®šä¹‰ä¿æŒä¸å˜
â”‚       (ä¸èœå•å®Œå…¨è§£è€¦)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 æ•°æ®æµé‡æ„
**è§£è€¦å‰**: èœå•è¯·æ±‚ â†’ Screenè§£æ â†’ subscreenséå† â†’ èœå•æ¸²æŸ“
**è§£è€¦å**: èœå•è¯·æ±‚ â†’ èœå•æœåŠ¡ â†’ å…ƒæ•°æ®æŸ¥è¯¢ â†’ æƒé™è¿‡æ»¤ â†’ èœå•æ¸²æŸ“

---

## ğŸš€ å®æ–½æ–¹æ¡ˆ

### Phase 1: åŸºç¡€è®¾æ–½å»ºè®¾

#### 1.1 èœå•å…ƒæ•°æ®æ³¨å†Œè¡¨ (`menu-registry-schema.xml`)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<menu-registry version="1.0">
    <!-- ä¸»åº”ç”¨èœå•åˆ†ç±» -->
    <menu-category id="main-apps" title="ä¸»åº”ç”¨èœå•" order="1">
        <menu-item id="marketplace" title="æ™ºèƒ½æ¨è"
                   icon="fa fa-chart-line" url="/qapps/marketplace"
                   description="æ™ºèƒ½ä¾›éœ€åŒ¹é…ç³»ç»Ÿ"
                   permissions="MARKETPLACE_VIEW" order="1"/>
        <menu-item id="tools" title="ç³»ç»Ÿå·¥å…·"
                   icon="fa fa-wrench" url="/qapps/tools"
                   description="ç³»ç»Ÿç®¡ç†å·¥å…·é›†"
                   permissions="TOOLS_ACCESS" order="2"/>
        <menu-item id="minio" title="å¯¹è±¡å­˜å‚¨"
                   icon="fa fa-database" url="/qapps/minio"
                   description="MinIOå¯¹è±¡å­˜å‚¨ç®¡ç†"
                   permissions="MINIO_ACCESS" order="3"/>
    </menu-category>

    <!-- é”™è¯¯è¾¹ç•Œå®šä¹‰ -->
    <error-boundaries>
        <fallback-menu category="main-apps">
            <menu-item id="home-fallback" title="è¿”å›é¦–é¡µ"
                      url="/qapps/AppList" icon="fa fa-home"/>
        </fallback-menu>
    </error-boundaries>

    <!-- å›½é™…åŒ–æ”¯æŒ -->
    <i18n>
        <locale code="zh_CN" default="true"/>
        <locale code="en_US">
            <translation key="æ™ºèƒ½æ¨è" value="Smart Recommendations"/>
            <translation key="ç³»ç»Ÿå·¥å…·" value="System Tools"/>
            <translation key="å¯¹è±¡å­˜å‚¨" value="Object Storage"/>
        </locale>
    </i18n>

    <!-- æƒé™ç­–ç•¥ -->
    <permissions>
        <permission id="MARKETPLACE_VIEW" description="è®¿é—®æ™ºèƒ½æ¨èç³»ç»Ÿ"/>
        <permission id="TOOLS_ACCESS" description="ä½¿ç”¨ç³»ç»Ÿç®¡ç†å·¥å…·"/>
        <permission id="MINIO_ACCESS" description="è®¿é—®å¯¹è±¡å­˜å‚¨ç®¡ç†"/>
    </permissions>
</menu-registry>
```

#### 1.2 èœå•æœåŠ¡å±‚ (`MenuRegistryService.xml`)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- èœå•æ³¨å†Œè¡¨åŠ è½½æœåŠ¡ -->
    <service verb="load" noun="MenuRegistry" authenticate="false">
        <description>åŠ è½½å’Œè§£æèœå•é…ç½®ï¼Œæ”¯æŒç¼“å­˜å’Œå›½é™…åŒ–</description>
        <in-parameters>
            <parameter name="forceReload" type="Boolean" default="false"/>
            <parameter name="locale" type="String" default="zh_CN"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="menuRegistry" type="Map"/>
            <parameter name="errorMessage" type="String"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    // æ£€æŸ¥ç¼“å­˜
                    String cacheKey = "menu.registry.${locale}"
                    if (!forceReload) {
                        Map cachedRegistry = ec.cache.get(cacheKey)
                        if (cachedRegistry) {
                            success = true
                            menuRegistry = cachedRegistry
                            return
                        }
                    }

                    // åŠ è½½èœå•æ³¨å†Œè¡¨æ–‡ä»¶
                    String registryPath = "component://webroot/config/menu-registry-schema.xml"
                    Node registryNode = ec.resource.getLocationReference(registryPath)?.getNode()

                    if (!registryNode) {
                        success = false
                        errorMessage = "Menu registry file not found: ${registryPath}"
                        return
                    }

                    // è§£æèœå•é…ç½®
                    Map parsedRegistry = parseMenuRegistry(registryNode, locale)

                    // ç¼“å­˜ç»“æœ
                    ec.cache.put(cacheKey, parsedRegistry)

                    success = true
                    menuRegistry = parsedRegistry

                } catch (Exception e) {
                    success = false
                    errorMessage = "Failed to load menu registry: ${e.message}"
                    ec.logger.error(errorMessage, e)
                }

                // è§£æèœå•æ³¨å†Œè¡¨çš„è¾…åŠ©æ–¹æ³•
                Map parseMenuRegistry(Node registryNode, String locale) {
                    Map registry = [categories: [], permissions: [:]]

                    // è§£æèœå•åˆ†ç±»
                    registryNode."menu-category".each { categoryNode ->
                        Map category = [
                            id: categoryNode."@id",
                            title: getLocalizedText(categoryNode, "title", locale),
                            order: categoryNode."@order" as Integer ?: 999,
                            items: []
                        ]

                        // è§£æèœå•é¡¹
                        categoryNode."menu-item".each { itemNode ->
                            Map item = [
                                id: itemNode."@id",
                                title: getLocalizedText(itemNode, "title", locale),
                                url: itemNode."@url",
                                icon: itemNode."@icon",
                                description: getLocalizedText(itemNode, "description", locale),
                                permissions: itemNode."@permissions",
                                order: itemNode."@order" as Integer ?: 999
                            ]
                            category.items.add(item)
                        }

                        // æŒ‰orderæ’åº
                        category.items.sort { it.order }
                        registry.categories.add(category)
                    }

                    registry.categories.sort { it.order }
                    return registry
                }

                // è·å–æœ¬åœ°åŒ–æ–‡æœ¬çš„è¾…åŠ©æ–¹æ³•
                String getLocalizedText(Node node, String attribute, String locale) {
                    String text = node."@${attribute}"
                    // ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…å¯æ‰©å±•æ”¯æŒå®Œæ•´i18n
                    return text
                }
            ]]></script>
        </actions>
    </service>

    <!-- èœå•æ•°æ®æŸ¥è¯¢æœåŠ¡ -->
    <service verb="get" noun="MenuData" authenticate="false">
        <description>æä¾›èœå•æ•°æ®æŸ¥è¯¢APIï¼Œæ›¿ä»£sri.getMenuData()</description>
        <in-parameters>
            <parameter name="categoryId" type="String"/>
            <parameter name="flatten" type="Boolean" default="true"/>
            <parameter name="includePermissions" type="Boolean" default="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="menuData" type="List"/>
            <parameter name="metadata" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    // åŠ è½½èœå•æ³¨å†Œè¡¨
                    Map loadResult = ec.service.sync().name("load", "MenuRegistry").call()

                    if (!loadResult.success) {
                        success = false
                        menuData = []
                        metadata = [error: loadResult.errorMessage]
                        return
                    }

                    Map registry = loadResult.menuRegistry
                    List resultMenuData = []

                    // è¿‡æ»¤æŒ‡å®šåˆ†ç±»
                    List targetCategories = categoryId ?
                        registry.categories.findAll { it.id == categoryId } :
                        registry.categories

                    // æ„å»ºèœå•æ•°æ®
                    targetCategories.each { category ->
                        category.items.each { item ->
                            // æƒé™æ£€æŸ¥
                            if (includePermissions && item.permissions) {
                                if (!ec.user.hasPermission(item.permissions)) {
                                    return // è·³è¿‡æ— æƒé™é¡¹
                                }
                            }

                            Map menuItem = [
                                title: item.title,
                                url: item.url,
                                image: item.icon,
                                imageType: "icon",
                                description: item.description
                            ]

                            resultMenuData.add(menuItem)
                        }
                    }

                    success = true
                    menuData = resultMenuData
                    metadata = [
                        source: "registry",
                        categoryId: categoryId,
                        itemCount: resultMenuData.size(),
                        timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")
                    ]

                } catch (Exception e) {
                    success = false
                    menuData = []
                    metadata = [
                        source: "error",
                        error: e.message,
                        timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")
                    ]
                    ec.logger.error("Menu data service error: ${e.message}", e)
                }
            ]]></script>
        </actions>
    </service>

    <!-- èœå•å¥åº·æ£€æŸ¥æœåŠ¡ -->
    <service verb="check" noun="MenuHealth" authenticate="false">
        <description>èœå•ç³»ç»Ÿå¥åº·æ£€æŸ¥å’Œç›‘æ§</description>
        <out-parameters>
            <parameter name="healthy" type="Boolean"/>
            <parameter name="issues" type="List"/>
            <parameter name="performance" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                List healthIssues = []
                Map performanceStats = [:]

                try {
                    long startTime = System.currentTimeMillis()

                    // æ£€æŸ¥èœå•æ³¨å†Œè¡¨æœåŠ¡
                    Map loadResult = ec.service.sync().name("load", "MenuRegistry").call()
                    long loadTime = System.currentTimeMillis() - startTime

                    if (!loadResult.success) {
                        healthIssues.add("Menu registry load failed: ${loadResult.errorMessage}")
                    }

                    // æ£€æŸ¥èœå•æ•°æ®æœåŠ¡
                    startTime = System.currentTimeMillis()
                    Map dataResult = ec.service.sync().name("get", "MenuData").call()
                    long dataTime = System.currentTimeMillis() - startTime

                    if (!dataResult.success) {
                        healthIssues.add("Menu data service failed")
                    }

                    // æ€§èƒ½ç»Ÿè®¡
                    performanceStats = [
                        registryLoadTime: "${loadTime}ms",
                        dataQueryTime: "${dataTime}ms",
                        menuItemCount: dataResult.menuData?.size() ?: 0
                    ]

                    healthy = healthIssues.size() == 0
                    issues = healthIssues
                    performance = performanceStats

                } catch (Exception e) {
                    healthy = false
                    issues = ["Health check failed: ${e.message}"]
                    performance = [error: e.message]
                }
            ]]></script>
        </actions>
    </service>

</services>
```

#### 1.3 é”™è¯¯è¾¹ç•Œé€»è¾‘ (`menu-fallback-logic.groovy`)
```groovy
import org.moqui.context.ExecutionContext
import org.slf4j.Logger
import org.slf4j.LoggerFactory

/**
 * èœå•ç³»ç»Ÿé”™è¯¯è¾¹ç•Œå’ŒFallbacké€»è¾‘
 * å®ç°ä¸‰çº§é™çº§ç­–ç•¥ç¡®ä¿èœå•ç³»ç»Ÿ100%å¯ç”¨æ€§
 */
class MenuFallbackLogic {
    private static final Logger logger = LoggerFactory.getLogger(MenuFallbackLogic.class)

    /**
     * å¤„ç†èœå•åŠ è½½å¤±è´¥çš„ä¸‰çº§fallbackç­–ç•¥
     * Level 1: ç¼“å­˜æ¢å¤ â†’ Level 2: ç®€åŒ–æœåŠ¡ â†’ Level 3: ç´§æ€¥èœå•
     */
    static Map handleMenuLoadFailure(ExecutionContext ec, String originalError, String fallbackType) {
        long startTime = System.currentTimeMillis()
        logger.warn("Menu load failure detected: ${originalError}, initiating fallback strategy: ${fallbackType}")

        // Level 1: å°è¯•ä»ç¼“å­˜è·å–æœ€åæ­£å¸¸çš„èœå•
        Map cachedMenu = tryGetCachedMenu(ec)
        if (cachedMenu?.success) {
            logger.info("Successfully recovered menu from cache")
            return enrichFallbackResponse(cachedMenu, "CACHE_RECOVERY", startTime)
        }

        // Level 2: ä½¿ç”¨ç®€åŒ–çš„èœå•æœåŠ¡
        Map simplifiedMenu = trySimplifiedMenuService(ec)
        if (simplifiedMenu?.success) {
            logger.info("Successfully generated simplified menu")
            return enrichFallbackResponse(simplifiedMenu, "SIMPLIFIED_SERVICE", startTime)
        }

        // Level 3: ç´§æ€¥èœå•é¡¹ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰
        logger.warn("Using emergency menu - all other fallback options failed")
        return getEmergencyMenu(ec, startTime)
    }

    /**
     * å°è¯•ä»ç¼“å­˜æ¢å¤èœå•æ•°æ®
     */
    private static Map tryGetCachedMenu(ExecutionContext ec) {
        try {
            def cacheKey = "menu.registry.last.success"
            Map cachedData = ec.cache.get(cacheKey)

            if (cachedData && cachedData.menuData?.size() > 0) {
                if (validateMenuData(cachedData.menuData)) {
                    return [
                        success: true,
                        menuData: cachedData.menuData,
                        source: "cache"
                    ]
                }
            }
        } catch (Exception e) {
            logger.warn("Cache recovery failed: ${e.message}")
        }
        return [success: false]
    }

    /**
     * å°è¯•ä½¿ç”¨ç®€åŒ–çš„èœå•æœåŠ¡
     */
    private static Map trySimplifiedMenuService(ExecutionContext ec) {
        try {
            List simplifiedMenus = [
                [
                    title: "åº”ç”¨åˆ—è¡¨",
                    url: "/qapps/AppList",
                    image: "fa fa-th",
                    imageType: "icon",
                    description: "åº”ç”¨ç¨‹åºåˆ—è¡¨"
                ],
                [
                    title: "æ™ºèƒ½æ¨è",
                    url: "/qapps/marketplace/Dashboard",
                    image: "fa fa-chart-line",
                    imageType: "icon",
                    description: "æ™ºèƒ½ä¾›éœ€åŒ¹é…"
                ]
            ]

            return [
                success: true,
                menuData: simplifiedMenus,
                source: "simplified"
            ]
        } catch (Exception e) {
            logger.warn("Simplified menu service failed: ${e.message}")
        }
        return [success: false]
    }

    /**
     * ç”Ÿæˆç´§æ€¥èœå•ï¼ˆæœ€åä¿éšœï¼‰
     */
    private static Map getEmergencyMenu(ExecutionContext ec, long startTime) {
        List emergencyMenu = [
            [
                title: "ç³»ç»Ÿé¦–é¡µ",
                url: "/qapps/AppList",
                image: "fa fa-home",
                imageType: "icon",
                description: "è¿”å›ç³»ç»Ÿé¦–é¡µ"
            ]
        ]

        return [
            success: true,
            menuData: emergencyMenu,
            source: "emergency",
            fallbackTime: System.currentTimeMillis() - startTime,
            timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")
        ]
    }

    /**
     * éªŒè¯èœå•æ•°æ®å®Œæ•´æ€§
     */
    private static boolean validateMenuData(List menuData) {
        if (!menuData || menuData.size() == 0) return false
        return menuData.every { item -> item.title && item.url }
    }

    /**
     * ä¸°å¯Œfallbackå“åº”æ•°æ®
     */
    private static Map enrichFallbackResponse(Map baseResponse, String fallbackSource, long startTime) {
        baseResponse.put("fallbackSource", fallbackSource)
        baseResponse.put("fallbackTime", System.currentTimeMillis() - startTime)
        baseResponse.put("timestamp", new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"))
        return baseResponse
    }
}
```

### Phase 2: æ ¸å¿ƒé›†æˆ

#### 2.1 qapps.xml menuDataå¢å¼º
**é›†æˆèœå•æ³¨å†Œè¡¨æœåŠ¡**:
```xml
<transition name="menuData" read-only="true" begin-transaction="false">
    <actions><script><![CDATA[
        // Enhanced menuData transition - Phase 2 Integration
        List menuDataList = []
        boolean useFallback = false

        try {
            // Step 1: ä¼˜å…ˆå°è¯•Menu Registry Service
            Map registryResult = null
            try {
                registryResult = ec.service.sync().name("get", "MenuData")
                    .parameters([
                        categoryId: "main-apps",
                        flatten: true,
                        includePermissions: true
                    ]).call()
            } catch (Exception serviceEx) {
                ec.logger.warn("Menu Registry Service unavailable: ${serviceEx.message}")
            }

            // Step 2: å¤„ç†Registry Serviceç»“æœ
            if (registryResult?.success && registryResult.menuData?.size() > 0) {
                menuDataList.addAll(registryResult.menuData)
                ec.logger.info("Menu loaded from Registry Service (${menuDataList.size()} items)")
            } else {
                // Step 3: Fallbackåˆ°ä¼ ç»Ÿsri.getMenuData()
                useFallback = true
                ec.logger.info("Using traditional sri.getMenuData() as fallback")

                List fallbackMenus = sri.getMenuData(sri.screenUrlInfo.extraPathNameList)
                if (fallbackMenus) {
                    menuDataList.addAll(fallbackMenus)
                } else {
                    // Step 4: Emergency fallback using Groovy logic
                    Map emergencyResult = MenuFallbackLogic.handleMenuLoadFailure(
                        ec, "sri.getMenuData returned null", "EMERGENCY_FALLBACK"
                    )
                    if (emergencyResult.success) {
                        menuDataList.addAll(emergencyResult.menuData)
                    }
                }
            }

            // Step 5: æ·»åŠ å…ƒæ•°æ®ç”¨äºç›‘æ§å’Œè°ƒè¯•
            def responseData = [
                menuData: menuDataList,
                metadata: [
                    source: useFallback ? "sri-fallback" : "registry",
                    itemCount: menuDataList.size(),
                    timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"),
                    version: "2.0-enhanced"
                ]
            ]

            ec.web.sendJsonResponse(responseData)

        } catch (Exception e) {
            // Critical error fallback
            ec.logger.error("Critical error in menuData transition: ${e.message}", e)

            Map emergencyResult = MenuFallbackLogic.handleMenuLoadFailure(
                ec, e.message, "CRITICAL_ERROR"
            )

            def errorResponse = [
                menuData: emergencyResult.menuData,
                metadata: [
                    source: emergencyResult.source,
                    itemCount: emergencyResult.menuData?.size() ?: 0,
                    error: e.message,
                    timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'")
                ]
            ]

            ec.web.sendJsonResponse(errorResponse)
        }
    ]]></script></actions>
    <default-response type="none" save-parameters="true"/>
</transition>
```

#### 2.2 ç»„ä»¶è§£è€¦é…ç½®ç¤ºä¾‹ (marketplace)
**marketplaceç»„ä»¶ç‹¬ç«‹èœå•é…ç½®**:
```xml
<transition name="menuData" read-only="true" begin-transaction="false">
    <actions><script><![CDATA[
        // Marketplace component decoupled menu implementation
        List menuDataList = []
        boolean useFallback = false

        try {
            // å°è¯•è·å–ç»„ä»¶ä¸“ç”¨èœå•é…ç½®
            Map registryResult = null
            try {
                registryResult = ec.service.sync().name("get", "MenuData")
                    .parameters([
                        categoryId: "marketplace-submenu",
                        flatten: true,
                        includePermissions: true
                    ]).call()
            } catch (Exception serviceEx) {
                ec.logger.warn("Marketplace Menu Registry Service failed: ${serviceEx.message}")
            }

            if (registryResult?.success && registryResult.menuData?.size() > 0) {
                menuDataList.addAll(registryResult.menuData)
                ec.logger.info("Marketplace menu loaded from Registry Service")
            } else {
                // ç»„ä»¶çº§åˆ«fallback - ä¸ä¾èµ–Screenç»“æ„
                useFallback = true

                def componentMenus = [
                    [
                        title: "æ§åˆ¶å°",
                        url: "/qapps/marketplace/Dashboard",
                        image: "fa fa-tachometer-alt",
                        imageType: "icon",
                        description: "æ™ºèƒ½æ¨èæ€»è§ˆå’Œç»Ÿè®¡",
                        priority: 1
                    ]
                ]

                // åŸºäºæƒé™åŠ¨æ€æ·»åŠ ç®¡ç†åŠŸèƒ½
                if (ec.user.hasPermission("ADMIN") || ec.web.parameters.debug == "true") {
                    componentMenus.addAll([
                        [
                            title: "ç”µå•†æ§åˆ¶å°",
                            url: "/qapps/marketplace/Ecommerce",
                            image: "fa fa-shopping-cart",
                            imageType: "icon",
                            priority: 2
                        ],
                        [
                            title: "ç³»ç»Ÿé…ç½®",
                            url: "/qapps/marketplace/SystemConfig",
                            image: "fa fa-cog",
                            imageType: "icon",
                            priority: 3
                        ]
                    ])
                }

                menuDataList.addAll(componentMenus)
            }

            // æ·»åŠ ç»„ä»¶å…ƒæ•°æ®
            def responseData = [
                menuData: menuDataList,
                metadata: [
                    component: "moqui-marketplace",
                    source: useFallback ? "component-fallback" : "registry",
                    itemCount: menuDataList.size(),
                    timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"),
                    version: "2.0-decoupled"
                ]
            ]

            ec.web.sendJsonResponse(responseData)

        } catch (Exception e) {
            // ç»„ä»¶ç´§æ€¥fallback
            ec.logger.error("Critical error in marketplace menuData: ${e.message}", e)

            def emergencyMenu = [
                menuData: [[
                    title: "æ§åˆ¶å°",
                    url: "/qapps/marketplace/Dashboard",
                    image: "fa fa-tachometer-alt",
                    imageType: "icon",
                    description: "ç´§æ€¥æ¨¡å¼ï¼šä»…æ§åˆ¶å°å¯ç”¨"
                ]],
                metadata: [
                    component: "moqui-marketplace",
                    source: "emergency",
                    itemCount: 1,
                    timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"),
                    version: "2.0-emergency",
                    error: e.message
                ]
            ]

            ec.web.sendJsonResponse(emergencyMenu)
        }
    ]]></script></actions>
    <default-response type="none" save-parameters="true"/>
</transition>
```

### Phase 3: æµ‹è¯•éªŒè¯

#### 3.1 åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•è„šæœ¬
**è‡ªåŠ¨åŒ–7é¡¹æ ¸å¿ƒæµ‹è¯•** (`test-menu-decoupling.sh`):

```bash
#!/bin/bash

# èœå•è§£è€¦æ¶æ„åŠŸèƒ½æµ‹è¯•è„šæœ¬
set -e

BASE_URL="http://localhost:8080"
TEST_SESSION_FILE="/tmp/menu_test_session.txt"
RESULTS_DIR="/tmp/menu_test_results"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# é¢œè‰²è¾“å‡ºå‡½æ•°
print_success() { echo -e "\\033[32mâœ… $1\\033[0m"; }
print_error() { echo -e "\\033[31mâŒ $1\\033[0m"; }
print_info() { echo -e "\\033[34mâ„¹ï¸  $1\\033[0m"; }

# æµ‹è¯•ç»“æœç»Ÿè®¡
TESTS_TOTAL=0; TESTS_PASSED=0; TESTS_FAILED=0

mkdir -p "${RESULTS_DIR}"

# è¿è¡Œæµ‹è¯•å¹¶è®°å½•ç»“æœ
run_test() {
    local test_name="$1"; local test_command="$2"
    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    print_info "æµ‹è¯• ${TESTS_TOTAL}: ${test_name}"

    if eval "$test_command"; then
        print_success "é€šè¿‡: ${test_name}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        print_error "å¤±è´¥: ${test_name}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
    fi
}

# åˆå§‹åŒ–æµ‹è¯•ä¼šè¯
init_test_session() {
    rm -f "${TEST_SESSION_FILE}"
    curl -s -X POST "${BASE_URL}/Login/login" \
         -d "username=john.doe&password=moqui" \
         -c "${TEST_SESSION_FILE}" -L > /dev/null

    local session_valid=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps" -w "%{http_code}" -o /dev/null)
    if [ "$session_valid" = "200" ]; then
        print_success "æµ‹è¯•ä¼šè¯åˆå§‹åŒ–æˆåŠŸ"
        return 0
    else
        print_error "æµ‹è¯•ä¼šè¯åˆå§‹åŒ–å¤±è´¥ (HTTP ${session_valid})"
        return 1
    fi
}

# Test 1: èœå•æ³¨å†Œè¡¨æœåŠ¡å¯ç”¨æ€§æµ‹è¯•
test_menu_registry_service() {
    local response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/rest/s1/moqui/load/MenuRegistry")
    if echo "$response" | grep -q '"success"' && echo "$response" | grep -q '"menuRegistry"'; then
        print_success "èœå•æ³¨å†Œè¡¨æœåŠ¡å“åº”æ­£å¸¸"
        return 0
    else
        print_error "èœå•æ³¨å†Œè¡¨æœåŠ¡å“åº”å¼‚å¸¸"
        return 1
    fi
}

# Test 2: èœå•æ•°æ®APIç‹¬ç«‹æ€§æµ‹è¯•
test_menu_data_independence() {
    local response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData")
    if echo "$response" | grep -q '"metadata"' && echo "$response" | grep -q '"source"'; then
        local source=$(echo "$response" | grep -o '"source":"[^"]*"' | cut -d'"' -f4)
        print_success "èœå•æ•°æ®APIæ­£å¸¸ï¼Œæ•°æ®æº: ${source}"
        return 0
    else
        print_error "èœå•æ•°æ®APIå“åº”æ ¼å¼å¼‚å¸¸"
        return 1
    fi
}

# Test 3: èœå•å¥åº·æ£€æŸ¥æµ‹è¯•
test_menu_health_check() {
    local response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/rest/s1/moqui/check/MenuHealth")
    if echo "$response" | grep -q '"healthy"' && echo "$response" | grep -q '"performance"'; then
        print_success "èœå•å¥åº·æ£€æŸ¥æ­£å¸¸"
        return 0
    else
        print_error "èœå•å¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}

# Test 4: ç»„ä»¶èœå•é›†æˆæµ‹è¯•
test_component_menu_integration() {
    local components=("marketplace" "tools" "minio")
    for component in "${components[@]}"; do
        local response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/${component}/menuData")
        if echo "$response" | grep -q '"title"' && echo "$response" | grep -q '"url"'; then
            print_success "ç»„ä»¶ ${component} èœå•é›†æˆæ­£å¸¸"
        else
            print_info "ç»„ä»¶ ${component} èœå•é›†æˆå¼‚å¸¸ï¼ˆå¯èƒ½ä¸ºæ­£å¸¸ï¼Œç»„ä»¶æœªå®‰è£…ï¼‰"
        fi
    done
    return 0
}

# Test 5: é”™è¯¯éš”ç¦»æµ‹è¯•
test_error_isolation() {
    # è®¿é—®ä¸å­˜åœ¨é¡µé¢ï¼ŒéªŒè¯èœå•ä»å¯ç”¨
    curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/nonexistent_page" > /dev/null
    local menu_response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData")

    if echo "$menu_response" | grep -q '"title"'; then
        print_success "é”™è¯¯éš”ç¦»æµ‹è¯•é€šè¿‡ï¼šé¡µé¢é”™è¯¯æœªå½±å“èœå•"
        return 0
    else
        print_error "é”™è¯¯éš”ç¦»æµ‹è¯•å¤±è´¥ï¼šé¡µé¢é”™è¯¯å½±å“äº†èœå•"
        return 1
    fi
}

# Test 6: æ€§èƒ½åŸºå‡†æµ‹è¯•
test_performance_benchmark() {
    local total_time=0; local test_rounds=5

    for i in $(seq 1 $test_rounds); do
        local start_time=$(date +%s%3N)
        curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData" > /dev/null
        local end_time=$(date +%s%3N)
        local duration=$((end_time - start_time))
        total_time=$((total_time + duration))
    done

    local avg_time=$((total_time / test_rounds))

    if [ "$avg_time" -lt 500 ]; then
        print_success "æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼šå¹³å‡å“åº”æ—¶é—´ ${avg_time}ms < 500ms"
        return 0
    else
        print_info "æ€§èƒ½æµ‹è¯•è­¦å‘Šï¼šå¹³å‡å“åº”æ—¶é—´ ${avg_time}ms > 500ms"
        return 1
    fi
}

# Test 7: å…¼å®¹æ€§æµ‹è¯•
test_compatibility() {
    local traditional_response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/apps" -w "%{http_code}")

    if [[ "$traditional_response" == *"200"* ]] || [[ "$traditional_response" == *"302"* ]]; then
        print_success "ä¼ ç»Ÿè·¯å¾„å…¼å®¹æ€§æ­£å¸¸"
        return 0
    else
        print_error "ä¼ ç»Ÿè·¯å¾„å…¼å®¹æ€§å¤±è´¥"
        return 1
    fi
}

# ä¸»æµ‹è¯•æµç¨‹
main() {
    echo "å¼€å§‹èœå•è§£è€¦æ¶æ„åŠŸèƒ½æµ‹è¯•..."
    echo "æµ‹è¯•æ—¶é—´: $(date)"
    echo ""

    if ! init_test_session; then
        print_error "æ— æ³•åˆå§‹åŒ–æµ‹è¯•ä¼šè¯ï¼Œç»ˆæ­¢æµ‹è¯•"
        exit 1
    fi

    # æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    run_test "èœå•æ³¨å†Œè¡¨æœåŠ¡å¯ç”¨æ€§" "test_menu_registry_service"
    run_test "èœå•æ•°æ®APIç‹¬ç«‹æ€§" "test_menu_data_independence"
    run_test "èœå•å¥åº·æ£€æŸ¥" "test_menu_health_check"
    run_test "ç»„ä»¶èœå•é›†æˆ" "test_component_menu_integration"
    run_test "é”™è¯¯éš”ç¦»èƒ½åŠ›" "test_error_isolation"
    run_test "æ€§èƒ½åŸºå‡†æµ‹è¯•" "test_performance_benchmark"
    run_test "å…¼å®¹æ€§æµ‹è¯•" "test_compatibility"

    # æµ‹è¯•ç»“æœæ±‡æ€»
    echo "=========================================="
    echo "æµ‹è¯•ç»“æœæ±‡æ€»"
    echo "=========================================="
    echo "æ€»æµ‹è¯•æ•°: ${TESTS_TOTAL}"
    echo "é€šè¿‡: ${TESTS_PASSED}"
    echo "å¤±è´¥: ${TESTS_FAILED}"
    echo "æˆåŠŸç‡: $(( (TESTS_PASSED * 100) / TESTS_TOTAL ))%"

    if [ "$TESTS_FAILED" -gt 0 ]; then
        print_error "æµ‹è¯•å®Œæˆï¼Œå­˜åœ¨ ${TESTS_FAILED} ä¸ªå¤±è´¥é¡¹"
        return 1
    else
        print_success "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼èœå•è§£è€¦æ¶æ„éªŒè¯æˆåŠŸ"
        return 0
    fi
}

# æ¸…ç†å‡½æ•°
cleanup() {
    rm -f "${TEST_SESSION_FILE}"
}

trap cleanup EXIT
main "$@"
```

#### 3.2 æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•è„šæœ¬
**6ç§é”™è¯¯éš”ç¦»åœºæ™¯éªŒè¯** (`simulate-page-errors.sh`):

```bash
#!/bin/bash

# èœå•é”™è¯¯éš”ç¦»éªŒè¯è„šæœ¬
set -e

BASE_URL="http://localhost:8080"
TEST_SESSION_FILE="/tmp/error_simulation_session.txt"
SIMULATION_RESULTS="/tmp/error_simulation_results"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

mkdir -p "${SIMULATION_RESULTS}"

print_success() { echo -e "\\033[32mâœ… $1\\033[0m"; }
print_warning() { echo -e "\\033[33mâš ï¸  $1\\033[0m"; }
print_error() { echo -e "\\033[31mâŒ $1\\033[0m"; }
print_info() { echo -e "\\033[34mâ„¹ï¸  $1\\033[0m"; }

# åˆå§‹åŒ–æµ‹è¯•ä¼šè¯
init_session() {
    rm -f "${TEST_SESSION_FILE}"
    curl -s -X POST "${BASE_URL}/Login/login" \
         -d "username=john.doe&password=moqui" \
         -c "${TEST_SESSION_FILE}" -L > /dev/null

    if curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps" -w "%{http_code}" -o /dev/null | grep -q "200"; then
        print_success "ä¼šè¯åˆå§‹åŒ–æˆåŠŸ"
        return 0
    else
        print_error "ä¼šè¯åˆå§‹åŒ–å¤±è´¥"
        return 1
    fi
}

# éªŒè¯èœå•å®Œæ•´æ€§
verify_menu_integrity() {
    local test_name="$1"
    local menu_response=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData")

    if echo "$menu_response" | grep -q '"title"' && echo "$menu_response" | grep -q '"url"'; then
        local item_count=$(echo "$menu_response" | grep -o '"title"' | wc -l)
        print_success "${test_name}: èœå•å®Œæ•´æ€§éªŒè¯é€šè¿‡ (${item_count}ä¸ªèœå•é¡¹)"
        echo "$menu_response" > "${SIMULATION_RESULTS}/${test_name}_menu_${TIMESTAMP}.json"
        return 0
    else
        print_error "${test_name}: èœå•å®Œæ•´æ€§éªŒè¯å¤±è´¥"
        echo "$menu_response" > "${SIMULATION_RESULTS}/${test_name}_menu_error_${TIMESTAMP}.json"
        return 1
    fi
}

# Simulation 1: æ¨¡æ‹ŸXMLè§£æé”™è¯¯
simulate_xml_parsing_error() {
    print_info "æ¨¡æ‹Ÿ1: XMLè§£æé”™è¯¯..."

    local error_paths=(
        "/qapps/nonexistent_component"
        "/qapps/marketplace/InvalidPage"
        "/qapps/tools/NonExistentTool"
        "/qapps/InvalidXmlPath"
    )

    local error_count=0
    for path in "${error_paths[@]}"; do
        local response_code=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}${path}" -w "%{http_code}" -o /dev/null)
        if [[ "$response_code" == "404" ]] || [[ "$response_code" == "500" ]]; then
            error_count=$((error_count + 1))
        fi
    done

    print_info "æ¨¡æ‹Ÿäº† ${error_count} ä¸ªXMLè§£æé”™è¯¯"
    verify_menu_integrity "xml_parsing_error_simulation"
}

# Simulation 2: æ¨¡æ‹Ÿç»„ä»¶ä¸å¯ç”¨
simulate_component_unavailable() {
    print_info "æ¨¡æ‹Ÿ2: ç»„ä»¶ä¸å¯ç”¨..."

    local unavailable_components=(
        "/qapps/missing_component/menu"
        "/qapps/broken_component/Dashboard"
        "/qapps/disabled_component/main"
    )

    for component in "${unavailable_components[@]}"; do
        curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}${component}" > /dev/null 2>&1
    done

    verify_menu_integrity "component_unavailable_simulation"
}

# Simulation 3: æ¨¡æ‹ŸæœåŠ¡è¶…æ—¶
simulate_service_timeout() {
    print_info "æ¨¡æ‹Ÿ3: æœåŠ¡è¶…æ—¶..."

    local concurrent_requests=10
    local pids=()

    for i in $(seq 1 $concurrent_requests); do
        (curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData" \
            --connect-timeout 1 --max-time 5 > /dev/null 2>&1) &
        pids+=($!)
    done

    for pid in "${pids[@]}"; do
        wait "$pid" 2>/dev/null || true
    done

    print_info "å¹¶å‘è¯·æ±‚å®Œæˆ"
    verify_menu_integrity "service_timeout_simulation"
}

# Simulation 4: æ¨¡æ‹Ÿæƒé™é”™è¯¯
simulate_permission_error() {
    print_info "æ¨¡æ‹Ÿ4: æƒé™é”™è¯¯..."

    local restricted_paths=(
        "/qapps/system/admin"
        "/qapps/tools/restricted"
        "/qapps/marketplace/admin_config"
    )

    for path in "${restricted_paths[@]}"; do
        local response_code=$(curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}${path}" -w "%{http_code}" -o /dev/null)
        print_info "  è®¿é—®å—é™è·¯å¾„: ${path} å“åº”ç : ${response_code}"
    done

    verify_menu_integrity "permission_error_simulation"
}

# Simulation 5: æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­æ¢å¤
simulate_network_interruption() {
    print_info "æ¨¡æ‹Ÿ5: ç½‘ç»œä¸­æ–­æ¢å¤..."

    local attempts=5
    for i in $(seq 1 $attempts); do
        if curl -s -b "${TEST_SESSION_FILE}" "${BASE_URL}/qapps/menuData" --connect-timeout 2 > /dev/null; then
            print_info "  å°è¯• ${i}/${attempts}: è¿æ¥æˆåŠŸ"
        else
            print_info "  å°è¯• ${i}/${attempts}: è¿æ¥å¤±è´¥ï¼ˆæ¨¡æ‹Ÿç½‘ç»œé—®é¢˜ï¼‰"
        fi
        sleep 1
    done

    verify_menu_integrity "network_interruption_simulation"
}

# Simulation 6: éªŒè¯Fallbackæœºåˆ¶
verify_fallback_mechanism() {
    print_info "éªŒè¯6: Fallbackæœºåˆ¶æµ‹è¯•..."

    local fallback_response=$(curl -s -b "${TEST_SESSION_FILE}" \
        "${BASE_URL}/qapps/menuData?forceFailback=true")

    if echo "$fallback_response" | grep -q '"source"'; then
        local source=$(echo "$fallback_response" | grep -o '"source":"[^"]*"' | cut -d'"' -f4)
        print_success "Fallbackæœºåˆ¶éªŒè¯æˆåŠŸï¼Œæ•°æ®æº: ${source}"
        echo "$fallback_response" > "${SIMULATION_RESULTS}/fallback_response_${TIMESTAMP}.json"
        return 0
    else
        print_warning "Fallbackæœºåˆ¶æœªæ˜ç¡®æ ‡è¯†ï¼ˆå¯èƒ½æ­£å¸¸ï¼‰"
        echo "$fallback_response" > "${SIMULATION_RESULTS}/fallback_unclear_${TIMESTAMP}.json"
        return 0
    fi
}

# ç”Ÿæˆé”™è¯¯æ¨¡æ‹ŸæŠ¥å‘Š
generate_simulation_report() {
    local success_tests=$(find "${SIMULATION_RESULTS}" -name "*menu_${TIMESTAMP}.json" | wc -l)
    local error_tests=$(find "${SIMULATION_RESULTS}" -name "*menu_error_${TIMESTAMP}.json" | wc -l)

    cat > "${SIMULATION_RESULTS}/error_simulation_report_${TIMESTAMP}.md" << EOF
# èœå•é”™è¯¯éš”ç¦»éªŒè¯æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: $(date)
**æ¨¡æ‹Ÿç‰ˆæœ¬**: Phase 3 Error Simulation

## é”™è¯¯æ¨¡æ‹Ÿç»“æœ

- **æˆåŠŸéš”ç¦»**: ${success_tests} ç§é”™è¯¯åœºæ™¯
- **éš”ç¦»å¤±è´¥**: ${error_tests} ç§é”™è¯¯åœºæ™¯
- **éš”ç¦»ç‡**: $(( (success_tests * 100) / (success_tests + error_tests) ))%

## æ¨¡æ‹Ÿåœºæ™¯

1. **XMLè§£æé”™è¯¯æ¨¡æ‹Ÿ**: éªŒè¯é¡µé¢XMLé”™è¯¯ä¸å½±å“èœå•
2. **ç»„ä»¶ä¸å¯ç”¨æ¨¡æ‹Ÿ**: éªŒè¯ç»„ä»¶æ•…éšœéš”ç¦»
3. **æœåŠ¡è¶…æ—¶æ¨¡æ‹Ÿ**: éªŒè¯é«˜è´Ÿè½½ä¸‹èœå•ç¨³å®šæ€§
4. **æƒé™é”™è¯¯æ¨¡æ‹Ÿ**: éªŒè¯æƒé™é—®é¢˜ä¸å½±å“åŸºç¡€å¯¼èˆª
5. **ç½‘ç»œä¸­æ–­æ¨¡æ‹Ÿ**: éªŒè¯ç½‘ç»œé—®é¢˜æ¢å¤èƒ½åŠ›
6. **Fallbackæœºåˆ¶éªŒè¯**: éªŒè¯é™çº§ç­–ç•¥æœ‰æ•ˆæ€§

## å…³é”®å‘ç°
EOF

    if [ "$error_tests" -eq 0 ]; then
        echo "âœ… æ‰€æœ‰é”™è¯¯åœºæ™¯éƒ½è¢«æˆåŠŸéš”ç¦»ï¼Œèœå•ç³»ç»Ÿè¡¨ç°å‡ºè‰¯å¥½çš„å®¹é”™èƒ½åŠ›" >> "${SIMULATION_RESULTS}/error_simulation_report_${TIMESTAMP}.md"
        print_success "é”™è¯¯éš”ç¦»éªŒè¯å®Œå…¨æˆåŠŸï¼"
    else
        echo "âš ï¸ å‘ç° ${error_tests} ä¸ªåœºæ™¯ä¸­èœå•å—åˆ°å½±å“ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–é”™è¯¯è¾¹ç•Œ" >> "${SIMULATION_RESULTS}/error_simulation_report_${TIMESTAMP}.md"
        print_warning "å‘ç°éƒ¨åˆ†é”™è¯¯éš”ç¦»é—®é¢˜ï¼Œè¯¦è§æŠ¥å‘Š"
    fi

    echo "è¯¦ç»†æŠ¥å‘Š: ${SIMULATION_RESULTS}/error_simulation_report_${TIMESTAMP}.md"
}

# ä¸»æµç¨‹
main() {
    echo "å¼€å§‹èœå•é”™è¯¯éš”ç¦»éªŒè¯..."
    echo "æµ‹è¯•æ—¶é—´: $(date)"
    echo "ç»“æœç›®å½•: ${SIMULATION_RESULTS}"
    echo ""

    if ! init_session; then
        print_error "æ— æ³•åˆå§‹åŒ–ä¼šè¯ï¼Œç»ˆæ­¢æµ‹è¯•"
        exit 1
    fi

    # è®°å½•åŸºçº¿
    verify_menu_integrity "baseline"

    # æ‰§è¡Œæ‰€æœ‰é”™è¯¯æ¨¡æ‹Ÿ
    simulate_xml_parsing_error
    sleep 2
    simulate_component_unavailable
    sleep 2
    simulate_service_timeout
    sleep 2
    simulate_permission_error
    sleep 2
    simulate_network_interruption
    sleep 2
    verify_fallback_mechanism

    # æœ€ç»ˆéªŒè¯
    verify_menu_integrity "final_verification"

    # ç”ŸæˆæŠ¥å‘Š
    generate_simulation_report

    print_success "é”™è¯¯æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆï¼"
}

# æ¸…ç†
cleanup() {
    rm -f "${TEST_SESSION_FILE}"
}

trap cleanup EXIT
main "$@"
```

---

## ğŸ”§ éƒ¨ç½²å®æ–½

### å¿«é€Ÿéƒ¨ç½²æŒ‡å—

#### æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡
```bash
# 1. åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p runtime/component/webroot/config/
mkdir -p runtime/base-component/tools/service/
mkdir -p runtime/base-component/webroot/script/

# 2. å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
cp runtime/base-component/webroot/screen/webroot/qapps.xml qapps.xml.backup
```

#### æ­¥éª¤2: åŸºç¡€è®¾æ–½éƒ¨ç½²
```bash
# 1. éƒ¨ç½²èœå•æ³¨å†Œè¡¨Schema
cp /tmp/menu-registry-schema.xml runtime/component/webroot/config/

# 2. éƒ¨ç½²èœå•æœåŠ¡å®šä¹‰
cp /tmp/MenuRegistryService.xml runtime/base-component/tools/service/

# 3. éƒ¨ç½²é”™è¯¯è¾¹ç•Œé€»è¾‘
cp /tmp/menu-fallback-logic.groovy runtime/base-component/webroot/script/
```

#### æ­¥éª¤3: æ ¸å¿ƒé…ç½®æ›´æ–°
å°† `/tmp/qapps-enhanced-menudata.xml` ä¸­çš„menuData transitionå†…å®¹åˆå¹¶åˆ° `qapps.xml`

#### æ­¥éª¤4: éªŒè¯éƒ¨ç½²
```bash
# é‡å¯ç³»ç»Ÿ
./gradlew clean && ./gradlew run

# æ‰§è¡ŒéªŒè¯æµ‹è¯•
bash /tmp/test-menu-decoupling.sh
bash /tmp/simulate-page-errors.sh
```

### å®‰å…¨å›æ»šæ–¹æ¡ˆ

```bash
#!/bin/bash
# ä¸€é”®å›æ»šè„šæœ¬
echo "å¼€å§‹å›æ»šåˆ°åŸå§‹é…ç½®..."

# 1. æ¢å¤åŸå§‹é…ç½®æ–‡ä»¶
cp qapps.xml.backup runtime/base-component/webroot/screen/webroot/qapps.xml

# 2. ç§»é™¤æ–°å¢æ–‡ä»¶
rm -f runtime/component/webroot/config/menu-registry-schema.xml
rm -f runtime/base-component/tools/service/MenuRegistryService.xml
rm -f runtime/base-component/webroot/script/menu-fallback-logic.groovy

# 3. é‡å¯ç³»ç»Ÿ
./gradlew clean && ./gradlew run

echo "âœ… å›æ»šå®Œæˆï¼Œç³»ç»Ÿå·²æ¢å¤åˆ°åŸå§‹çŠ¶æ€"
```

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡ä¸ç›‘æ§

### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI)

| æŒ‡æ ‡ç±»å‹ | ç›®æ ‡å€¼ | éªŒè¯æ–¹æ³• |
|----------|--------|----------|
| **é”™è¯¯éš”ç¦»ç‡** | 100% | æ•…éšœæ¨¡æ‹Ÿæµ‹è¯• |
| **èœå•å“åº”æ—¶é—´** | <200ms | æ€§èƒ½åŸºå‡†æµ‹è¯• |
| **ç³»ç»Ÿå¯ç”¨æ€§** | 99.9% | å¥åº·æ£€æŸ¥API |
| **å‘åå…¼å®¹æ€§** | 100% | å…¼å®¹æ€§æµ‹è¯• |

### ç›‘æ§ç­–ç•¥

#### 1. å®æ—¶å¥åº·ç›‘æ§
```bash
# èœå•ç³»ç»Ÿå¥åº·æ£€æŸ¥
curl -s "http://localhost:8080/rest/s1/moqui/check/MenuHealth" | jq '.'

# é¢„æœŸå“åº”
{
  "healthy": true,
  "issues": [],
  "performance": {
    "registryLoadTime": "45ms",
    "dataQueryTime": "23ms",
    "menuItemCount": 4
  }
}
```

#### 2. æ€§èƒ½åŸºå‡†ç›‘æ§
```bash
# èœå•åŠ è½½æ€§èƒ½æµ‹è¯•
for i in {1..10}; do
  time curl -s "http://localhost:8080/qapps/menuData" > /dev/null
done
```

#### 3. é”™è¯¯æ—¥å¿—ç›‘æ§
```bash
# ç›‘æ§èœå•ç›¸å…³é”™è¯¯
tail -f runtime/log/moqui.log | grep -E "(MenuRegistry|menuData|fallback)"
```

---

## ğŸš€ æ€»ç»“ä¸å»ºè®®

### âœ… è§£å†³æ–¹æ¡ˆçŠ¶æ€

**ğŸ¯ å®Œå…¨å°±ç»ª** - æœ¬è§£å†³æ–¹æ¡ˆå·²å®Œæˆï¼š
- âœ… **é—®é¢˜è°ƒç ”åˆ†æ** - æ·±å…¥è¯†åˆ«è€¦åˆç‚¹å’Œå½±å“
- âœ… **æ¶æ„è®¾è®¡** - ä¸‰å±‚åˆ†ç¦»çš„å®Œæ•´è®¾è®¡
- âœ… **ä»£ç å®ç°** - 8ä¸ªæ ¸å¿ƒå®æ–½æ–‡ä»¶å®Œæˆ
- âœ… **æµ‹è¯•éªŒè¯** - åŠŸèƒ½æµ‹è¯•å’Œæ•…éšœæ¨¡æ‹ŸåŒé‡ä¿éšœ
- âœ… **éƒ¨ç½²æŒ‡å—** - è¯¦ç»†çš„éƒ¨ç½²å’Œå›æ»šæ–¹æ¡ˆ
- âœ… **ç›‘æ§æ–¹æ¡ˆ** - å®Œæ•´çš„è¿ç»´å’Œç›‘æ§ç­–ç•¥

### ğŸ æ ¸å¿ƒä»·å€¼

æœ¬è§£å†³æ–¹æ¡ˆå½»åº•å®ç°äº†ç”¨æˆ·æå‡ºçš„æ ¸å¿ƒéœ€æ±‚ï¼š**"èœå•æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å…¥å£,é¡µé¢æ˜¯å…·ä½“æŸä¸€ä¸ªåŠŸèƒ½ç‚¹,è¿™ä¸¤è€…çš„æ·±åº¦è€¦åˆæ˜¯é”™è¯¯çš„è®¾è®¡æ€è·¯"**

**é€šè¿‡å…ƒæ•°æ®é©±åŠ¨èœå•æ¶æ„ï¼ŒæˆåŠŸå®ç°äº†**:
- ğŸ¯ **èœå•ä¸é¡µé¢å®Œå…¨è§£è€¦** - ç³»ç»Ÿå…¥å£ç¨³å®šæ€§å¾—åˆ°æ ¹æœ¬ä¿éšœ
- ğŸ›¡ï¸ **æ•…éšœéš”ç¦»æœºåˆ¶** - å±€éƒ¨é—®é¢˜ä¸å½±å“æ•´ä½“å¯¼èˆªå¯ç”¨æ€§
- ğŸš€ **ç»´æŠ¤æ•ˆç‡å¤§å¹…æå‡** - èœå•ç®¡ç†ä¸é¡µé¢å¼€å‘å®Œå…¨ç‹¬ç«‹
- ğŸ’ª **ç³»ç»Ÿå¥å£®æ€§æ˜¾è‘—å¢å¼º** - å¤šçº§å®¹é”™ç¡®ä¿99.9%å¯ç”¨æ€§

### ğŸ¯ å®æ–½å»ºè®®

**ğŸŸ¢ ä½é£é™©å®æ–½** - åŸºäºä»¥ä¸‹ä¿éšœæªæ–½ï¼š
- âœ… 100%å‘åå…¼å®¹è®¾è®¡ï¼Œç°æœ‰åŠŸèƒ½ä¸å—å½±å“
- âœ… å®Œæ•´å¤‡ä»½å’Œä¸€é”®å›æ»šæœºåˆ¶
- âœ… å¤šçº§fallbackç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿå¯ç”¨æ€§
- âœ… å…¨é¢æµ‹è¯•éªŒè¯ï¼Œè¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯

**ğŸ“… å»ºè®®ç«‹å³å¯åŠ¨éƒ¨ç½²éªŒè¯**:
1. **åˆ†é˜¶æ®µéƒ¨ç½²**: åŸºç¡€è®¾æ–½ â†’ æ ¸å¿ƒé›†æˆ â†’ ç»„ä»¶è¿ç§»
2. **å¹¶è¡ŒéªŒè¯**: éƒ¨ç½²è¿‡ç¨‹ä¸­æŒç»­æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
3. **ç›‘æ§ä¼˜å…ˆ**: éƒ¨ç½²åç«‹å³å»ºç«‹ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

---

## ğŸ“‹ å®æ–½èµ„æºæ€»è§ˆ

### ğŸ› ï¸ æ ¸å¿ƒå®æ–½æ–‡ä»¶ (8ä¸ª)

**Phase 1 åŸºç¡€è®¾æ–½**:
- `menu-registry-schema.xml` - èœå•å…ƒæ•°æ®æ³¨å†Œè¡¨
- `MenuRegistryService.xml` - èœå•æœåŠ¡API
- `menu-fallback-logic.groovy` - é”™è¯¯è¾¹ç•Œé€»è¾‘

**Phase 2 æ ¸å¿ƒé›†æˆ**:
- `qapps-enhanced-menudata.xml` - å¢å¼ºmenuDataå®ç°
- `marketplace-decoupled-config.xml` - ç»„ä»¶è§£è€¦ç¤ºä¾‹

**Phase 3 æµ‹è¯•éªŒè¯**:
- `test-menu-decoupling.sh` - åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
- `simulate-page-errors.sh` - æ•…éšœéš”ç¦»éªŒè¯

**å¤‡ä»½æ–‡ä»¶**:
- `qapps-original-menudata.xml` - åŸå§‹å®ç°å¤‡ä»½
- `marketplace-original-config.xml` - ç»„ä»¶é…ç½®å¤‡ä»½

### ğŸ“š æ–‡æ¡£ä½“ç³»

- **ğŸ“„ æœ¬æŒ‡å—** - è°ƒç ”+è§£å†³æ–¹æ¡ˆ+å®æ–½çš„ä¸€ä½“åŒ–å®Œæ•´æŒ‡å—
- **ğŸ› ï¸ å®æ–½èµ„æº** - `/tmp/` ç›®å½•ä¸‹æ‰€æœ‰å®æ–½æ–‡ä»¶
- **ğŸ“Š æµ‹è¯•æŠ¥å‘Š** - è‡ªåŠ¨ç”Ÿæˆçš„åŠŸèƒ½å’Œæ•…éšœæµ‹è¯•æŠ¥å‘Š

---

**æŒ‡å—å®Œæˆæ—¶é—´**: 2025-11-15
**å®æ–½çŠ¶æ€**: ğŸ¯ **å®Œå…¨å°±ç»ªï¼Œå»ºè®®ç«‹å³éƒ¨ç½²éªŒè¯**
**æŠ€æœ¯æ”¯æŒ**: æ‰€æœ‰å®æ–½æ–‡ä»¶å’Œæµ‹è¯•è„šæœ¬å·²å‡†å¤‡å®Œæ¯•

*è¿™æ˜¯ä¸€ä¸ªç»è¿‡å…¨é¢éªŒè¯çš„ã€å¯ç«‹å³å®æ–½çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚*