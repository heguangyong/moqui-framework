class r{constructor(){this.config=this.loadConfig(),this.cache=new Map}loadConfig(){const e=localStorage.getItem("image_generation_config");if(e)try{return JSON.parse(e)}catch(t){console.warn("Failed to parse image generation config:",t)}return{provider:"pollinations",size:"800x450"}}saveConfig(e){this.config={...this.config,...e},localStorage.setItem("image_generation_config",JSON.stringify(this.config)),console.log("âœ… Image generation config saved:",this.config)}getConfig(){return{...this.config}}async generateImage(e){const t=this.getCacheKey(e);if(this.cache.has(t))return console.log("ğŸ“¦ Using cached image for:",e.prompt.substring(0,50)),this.cache.get(t);console.log(`ğŸ¨ Generating image with ${this.config.provider}:`,e.prompt.substring(0,50));let a;try{switch(this.config.provider){case"stable-diffusion":a=await this.generateWithStableDiffusion(e);break;case"dalle":a=await this.generateWithDALLE(e);break;case"pollinations":a=await this.generateWithPollinations(e);break;case"placeholder":default:a=await this.generatePlaceholder(e);break}return this.cache.set(t,a),a}catch(o){return console.error("âŒ Image generation failed:",o),console.log("âš ï¸ Falling back to placeholder image"),a=await this.generatePlaceholder(e),a}}async generateBatch(e){console.log(`ğŸ¨ Batch generating ${e.length} images...`);const t=[];for(let a=0;a<e.length;a++)try{const o=await this.generateImage(e[a]);t.push(o),console.log(`âœ… Generated ${a+1}/${e.length}`)}catch(o){console.error(`âŒ Failed to generate image ${a+1}:`,o),t.push(await this.generatePlaceholder(e[a]))}return t}async generateWithStableDiffusion(e){const t=this.config.apiUrl||"http://localhost:7860",a={prompt:this.enhancePrompt(e.prompt),negative_prompt:e.negativePrompt||"blurry, low quality, distorted, ugly",width:e.width||800,height:e.height||450,steps:e.steps||20,seed:e.seed||-1,sampler_name:"DPM++ 2M Karras",cfg_scale:7,batch_size:1};console.log("ğŸ“¡ Calling Stable Diffusion API:",t);const o=await fetch(`${t}/sdapi/v1/txt2img`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok)throw new Error(`Stable Diffusion API error: ${o.status} ${o.statusText}`);const s=await o.json();if(!s.images||s.images.length===0)throw new Error("No images returned from Stable Diffusion");const i=`data:image/png;base64,${s.images[0]}`;return{imageUrl:i,thumbnailUrl:i,prompt:e.prompt,provider:"stable-diffusion",generatedAt:new Date}}async generateWithDALLE(e){if(!this.config.apiKey)throw new Error("DALL-E API key not configured");const t="https://api.openai.com/v1/images/generations",a={model:this.config.model||"dall-e-3",prompt:this.enhancePrompt(e.prompt),n:1,size:this.config.size||"1024x1024",quality:this.config.quality||"standard"};console.log("ğŸ“¡ Calling DALL-E API");const o=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a)});if(!o.ok){const n=await o.json();throw new Error(`DALL-E API error: ${n.error?.message||o.statusText}`)}const s=await o.json();if(!s.data||s.data.length===0)throw new Error("No images returned from DALL-E");const i=s.data[0].url;return{imageUrl:i,thumbnailUrl:i,prompt:e.prompt,provider:"dalle",generatedAt:new Date}}async generateWithPollinations(e){const t=encodeURIComponent(this.enhancePrompt(e.prompt)),a=e.width||800,o=e.height||450,s=e.seed||Math.floor(Math.random()*1e6),i=`https://image.pollinations.ai/prompt/${t}?width=${a}&height=${o}&seed=${s}&nologo=true`;return console.log("ğŸ“¡ Calling Pollinations AI:",i.substring(0,100)+"..."),{imageUrl:i,thumbnailUrl:i,prompt:e.prompt,provider:"pollinations",generatedAt:new Date}}async generatePlaceholder(e){const t=e.width||800,a=e.height||450,s=this.extractKeywords(e.prompt).slice(0,3).join(" ")||"åˆ†é•œ",i=this.generateSVGPlaceholder(t,a,s),n=this.generateSVGPlaceholder(150,150,s);return{imageUrl:i,thumbnailUrl:n,prompt:e.prompt,provider:"placeholder",generatedAt:new Date}}generateSVGPlaceholder(e,t,a){const o=`
      <svg width="${e}" height="${t}" xmlns="http://www.w3.org/2000/svg">
        <rect width="100%" height="100%" fill="#7a9188"/>
        <text 
          x="50%" 
          y="50%" 
          dominant-baseline="middle" 
          text-anchor="middle" 
          font-family="Arial, sans-serif" 
          font-size="20" 
          fill="#ffffff"
        >${a}</text>
      </svg>
    `.trim();return`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(o)))}`}enhancePrompt(e){return`${e}, ${["anime style","high quality","detailed","cinematic lighting","professional composition"].join(", ")}`}extractKeywords(e){return e.split(/[,ï¼Œã€‚ã€\s]+/).filter(a=>a.length>1).slice(0,5)}getCacheKey(e){return`${this.config.provider}_${e.prompt}_${e.width||800}x${e.height||450}`}clearCache(){this.cache.clear(),console.log("ğŸ—‘ï¸ Image cache cleared")}async testConnection(){try{switch(this.config.provider){case"stable-diffusion":return await this.testStableDiffusion();case"dalle":return await this.testDALLE();case"pollinations":return{success:!0,message:"Pollinations AI æ— éœ€é…ç½®ï¼Œå¯ç›´æ¥ä½¿ç”¨"};case"placeholder":return{success:!0,message:"Placeholder service is always available"};default:return{success:!1,message:"Unknown provider"}}}catch(e){return{success:!1,message:e.message}}}async testStableDiffusion(){const e=this.config.apiUrl||"http://localhost:7860";try{const t=await fetch(`${e}/sdapi/v1/sd-models`,{method:"GET"});return t.ok?{success:!0,message:`Connected to Stable Diffusion. ${(await t.json()).length} models available.`}:{success:!1,message:`Failed to connect: ${t.status} ${t.statusText}`}}catch(t){return{success:!1,message:`Connection error: ${t.message}`}}}async testDALLE(){if(!this.config.apiKey)return{success:!1,message:"API key not configured"};try{const e=await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}});return e.ok?{success:!0,message:"Connected to DALL-E API successfully"}:{success:!1,message:`API key validation failed: ${e.status}`}}catch(e){return{success:!1,message:`Connection error: ${e.message}`}}}}const l=new r;export{l as imageGenerationService};
