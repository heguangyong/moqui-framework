import{defineStore as c}from"./pinia-Be3yrKEl.js";import{a as n,f as o}from"./_plugin-vue_export-helper-BFgqyxDe.js";import"./runtime-core.esm-bundler-8-XbLWPr.js";import"./preload-helper-CmsKOCeN.js";class h{constructor(){this.baseUrl="http://localhost:8080",this.api=n.create({baseURL:this.baseUrl,timeout:15e3,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.api.interceptors.request.use(s=>{const t=localStorage.getItem("novel_anime_access_token");return t&&(s.headers.Authorization=`Bearer ${t}`),s},s=>Promise.reject(s)),this.api.interceptors.response.use(s=>s,async s=>(s.response?.status===401&&(localStorage.removeItem("novel_anime_access_token"),localStorage.removeItem("novel_anime_refresh_token")),Promise.reject(s)))}async getBalance(){try{return{success:!0,data:(await this.api.get("/rest/s1/novel-anime/credits/balance")).data}}catch(s){return{success:!1,error:s.response?.data?.message||s.message||"获取积分余额失败"}}}async consume(s){try{return{success:!0,data:(await this.api.post("/rest/s1/novel-anime/credits/consume",s)).data}}catch(t){return{success:!1,error:t.response?.data?.message||t.message||"消费积分失败"}}}async getHistory(s){try{return{success:!0,data:(await this.api.get("/rest/s1/novel-anime/credits/history",{params:s})).data}}catch(t){return{success:!1,error:t.response?.data?.message||t.message||"获取积分历史失败"}}}}const a=new h,i=()=>({balance:0,isLow:!1,history:[],totalHistoryCount:0,currentPage:1,pageSize:20,totalPages:0,isLoading:!1,error:null}),f=c("credits",{state:()=>i(),getters:{hasSufficientCredits:e=>s=>e.balance>=s,formattedBalance:e=>e.balance.toLocaleString(),hasMoreHistory:e=>e.currentPage<e.totalPages,recentTransactions:e=>e.history.slice(0,5)},actions:{async fetchBalance(){this.isLoading=!0,this.error=null;try{const e=await a.getBalance();return e.success&&e.data?.success?(this.balance=e.data.balance,this.isLow=e.data.isLow,o().updateCredits(this.balance),{success:!0,balance:this.balance,isLow:this.isLow}):(this.error=e.data?.message||e.error||"获取积分余额失败",{success:!1,error:this.error})}catch(e){return this.error=e.message||"获取积分余额失败",{success:!1,error:this.error}}finally{this.isLoading=!1}},async consumeCredits(e,s,t){if(this.balance<e)return{success:!1,error:`积分不足。需要: ${e}, 当前: ${this.balance}`,errorCode:"INSUFFICIENT_CREDITS"};this.isLoading=!0,this.error=null;try{const r=await a.consume({amount:e,operationType:s,description:t});return r.success&&r.data?.success?(this.balance=r.data.newBalance,this.isLow=this.balance<50,o().updateCredits(this.balance),{success:!0,newBalance:this.balance,transactionId:r.data.transactionId}):(this.error=r.data?.message||r.error||"消费积分失败",{success:!1,error:this.error,errorCode:r.data?.errorCode})}catch(r){return this.error=r.message||"消费积分失败",{success:!1,error:this.error}}finally{this.isLoading=!1}},async fetchHistory(e=1,s){this.isLoading=!0,this.error=null;try{const t=await a.getHistory({page:e,pageSize:this.pageSize,type:s});return t.success&&t.data?.success?(e===1?this.history=t.data.transactions:this.history=[...this.history,...t.data.transactions],this.totalHistoryCount=t.data.totalCount,this.currentPage=t.data.page,this.totalPages=t.data.totalPages,{success:!0,transactions:t.data.transactions}):(this.error=t.data?.message||t.error||"获取积分历史失败",{success:!1,error:this.error})}catch(t){return this.error=t.message||"获取积分历史失败",{success:!1,error:this.error}}finally{this.isLoading=!1}},async loadMoreHistory(e){return this.hasMoreHistory?this.fetchHistory(this.currentPage+1,e):{success:!1,error:"没有更多记录"}},async refreshHistory(e){return this.history=[],this.currentPage=1,this.fetchHistory(1,e)},checkSufficientCredits(e){return this.balance>=e},getOperationCost(e){return{"novel-parse":10,"character-extract":20,"video-generate":50,"image-analyze":15,"voice-recognize":5}[e]||10},updateBalance(e){this.balance=e,this.isLow=e<50},resetState(){const e=i();Object.assign(this,e)},clearError(){this.error=null}}});export{f as useCreditsStore};
