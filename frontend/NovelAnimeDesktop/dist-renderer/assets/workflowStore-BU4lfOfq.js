import{defineStore as W}from"./pinia-Be3yrKEl.js";import{a as f}from"./api-BR07cdPl.js";import{_ as x}from"./preload-helper-CmsKOCeN.js";import{C as p}from"./CharacterSystem-9i6-R3qi.js";import"./runtime-core.esm-bundler-8-XbLWPr.js";import"./_plugin-vue_export-helper-BFgqyxDe.js";function m(n,e){if(n==null)return e;if(typeof n=="string")try{return JSON.parse(n)}catch{return e}return n}function y(n){const e=m(n.nodes,[]),t=m(n.connections,[]);return{id:n.workflowId,name:n.name||"",description:n.description||"",nodes:e,connections:t,configuration:{autoStart:!1,parallelExecution:!0,errorHandling:"stop",maxRetries:3},status:n.status||"idle",projectId:n.projectId,createdAt:n.createdDate||new Date().toISOString(),updatedAt:n.lastUpdatedDate||new Date().toISOString()}}async function v(n){try{const e=await f.getWorkflows(n);return e.success?{success:!0,data:{workflows:(e.workflows||[]).map(y)}}:{success:!1,message:e.message||"Failed to get workflows",data:{workflows:[]}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.error("[workflowService] getWorkflows failed:",t),{success:!1,message:t,data:{workflows:[]}}}}async function I(n){try{const e=await f.getWorkflow(n);return!e.success||!e.workflow?{success:!1,message:e.message||"Workflow not found",data:{workflow:null}}:{success:!0,data:{workflow:y(e.workflow)}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.error("[workflowService] getWorkflow failed:",t),{success:!1,message:t,data:{workflow:null}}}}async function N(n){try{const e={name:n.name,description:n.description||"",status:"idle",nodes:[],connections:[],projectId:n.projectId},t=await f.createWorkflow(e);if(!t.success||!t.workflowId)return{success:!1,message:t.message||"Failed to create workflow",data:{workflow:null,workflowId:null}};const o={id:t.workflowId,name:n.name,description:n.description||"",nodes:[],connections:[],configuration:{autoStart:!1,parallelExecution:!0,errorHandling:"stop",maxRetries:3},status:"idle",projectId:n.projectId,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return{success:!0,data:{workflow:o,workflowId:o.id}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.error("[workflowService] createWorkflow failed:",t),{success:!1,message:t,data:{workflow:null,workflowId:null}}}}async function k(n,e){try{const t={};e.name!==void 0&&(t.name=e.name),e.description!==void 0&&(t.description=e.description),e.status!==void 0&&(t.status=e.status),e.nodes!==void 0&&(t.nodes=JSON.stringify(e.nodes)),e.connections!==void 0&&(t.connections=JSON.stringify(e.connections));const o=await f.updateWorkflow(n,t);return o.success?{success:!0,data:{workflow:(await I(n)).data?.workflow||null}}:{success:!1,message:o.message||"Failed to update workflow",data:{workflow:null}}}catch(t){const o=t instanceof Error?t.message:"Unknown error";return console.error("[workflowService] updateWorkflow failed:",o),{success:!1,message:o,data:{workflow:null}}}}async function C(n){try{const e=await f.deleteWorkflow(n);return e.success?{success:!0}:{success:!1,message:e.message||"Failed to delete workflow"}}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.error("[workflowService] deleteWorkflow failed:",t),{success:!1,message:t}}}function E(n){const e=[],t=[];n.nodes.length===0&&e.push({message:"Workflow must have at least one node"});const o=new Set;n.connections.forEach(r=>{o.add(r.fromNodeId),o.add(r.toNodeId)}),n.nodes.forEach(r=>{!o.has(r.id)&&n.nodes.length>1&&t.push({message:`Node "${r.name}" is not connected to the workflow`,nodeId:r.id})});const s=new Set(n.nodes.map(r=>r.id));return n.connections.forEach(r=>{s.has(r.fromNodeId)||e.push({message:`Connection references non-existent source node: ${r.fromNodeId}`}),s.has(r.toNodeId)||e.push({message:`Connection references non-existent target node: ${r.toNodeId}`})}),{isValid:e.length===0,errors:e,warnings:t}}function S(n,e){let o=n;if(n.length>20&&(o=n.substring(0,20)),!e.includes(o))return o;let s=2,r=`${o} (${s})`;for(;e.includes(r);)s++,r=`${o} (${s})`;return r}function P(){return`node_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function _(){return`conn_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function F(n){return JSON.stringify(n,null,2)}function $(n){try{const e=JSON.parse(n);if(!e.id||!e.name||!Array.isArray(e.nodes))throw new Error("Invalid workflow structure");return e.id=`workflow_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,e}catch(e){return console.error("[workflowService] Failed to import workflow:",e),null}}class w{static{this.SUPPORTED_FORMATS=[".txt"]}static{this.MAX_FILE_SIZE=1024*1024}static{this.ENCODING_PATTERNS={UTF8:/^[\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}$/,UTF16:/^\xFF\xFE|\xFE\xFF/,ASCII:/^[\x00-\x7F]*$/}}static validateFile(e){const t=[],o=[],s=this.getFileExtension(e.name);return this.SUPPORTED_FORMATS.includes(s)||t.push({code:"INVALID_FORMAT",message:`Unsupported file format: ${s}. Only TXT files are supported.`,field:"fileFormat",severity:"error"}),e.size>this.MAX_FILE_SIZE&&t.push({code:"FILE_TOO_LARGE",message:`File size (${this.formatFileSize(e.size)}) exceeds maximum allowed size (${this.formatFileSize(this.MAX_FILE_SIZE)}).`,field:"fileSize",severity:"error"}),e.size===0&&t.push({code:"EMPTY_FILE",message:"File is empty. Please upload a file with content.",field:"fileContent",severity:"error"}),e.size<1e3&&e.size>0&&o.push({code:"SMALL_FILE",message:"File appears to be very small. Please ensure it contains a complete novel.",field:"fileSize",severity:"warning"}),{isValid:t.length===0,errors:t,warnings:o}}static async extractTextContent(e){return new Promise((t,o)=>{const s=new FileReader;s.onload=r=>{try{const a=r.target?.result;if(!a){o(new Error("Failed to read file content"));return}const c=this.detectAndCleanEncoding(a);t(c)}catch(a){o(new Error(`Failed to extract text content: ${a}`))}},s.onerror=()=>{o(new Error("Failed to read file"))},s.readAsText(e,"UTF-8")})}static detectAndCleanEncoding(e){let t=e.replace(/^\uFEFF/,"");return t=t.replace(/\r\n/g,`
`).replace(/\r/g,`
`),t=t.replace(/\n{3,}/g,`

`),t=t.trim(),t}static detectChapterBoundaries(e){const t=[],o=e.split(`
`),s=[/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+ç« /i,/^Chapter\s+(\d+|[IVXLCDM]+|One|Two|Three|Four|Five|Six|Seven|Eight|Nine|Ten)/i,/^ç¬¬\s*(\d+)\s*ç« /i,/^ç« èŠ‚\s*(\d+)/i,/^\d+\.\s/,/^[IVXLCDM]+\.\s/i,/^-{3,}.*ç¬¬.*ç« .*-{3,}/i,/^={3,}.*Chapter.*={3,}/i,/^\*{3,}.*ç¬¬.*ç« .*\*{3,}/i,/^ç¬¬[0-9]+ç« /i,/^CHAPTER\s+(ONE|TWO|THREE|FOUR|FIVE|SIX|SEVEN|EIGHT|NINE|TEN|\d+|[IVXLCDM]+)/i];let r=null,a=[],c=0;for(let i=0;i<o.length;i++){const l=o[i].trim();if(s.some(d=>d.test(l))){if(r){let h=a.join(`
`).trim();h=h.replace(/\n{3,}/g,`

`),r.content=h,r.wordCount=this.countWords(r.content),r.scenes=h.length>0?this.detectScenes(r.content,r.id):[],t.push(r)}c++,r={id:`chapter_${c}`,title:l||`Chapter ${c}`,content:"",wordCount:0,scenes:[]},a=[]}else l.length>0?a.push(l):a.length>0&&a.push("")}if(r){let i=a.join(`
`).trim();i=i.replace(/\n{3,}/g,`

`),r.content=i,r.wordCount=this.countWords(r.content),r.scenes=i.length>0?this.detectScenes(r.content,r.id):[],t.push(r)}if(t.length===0&&e.trim().length>0){const i={id:"chapter_1",title:"Chapter 1",content:e.trim(),wordCount:this.countWords(e),scenes:this.detectScenes(e,"chapter_1")};t.push(i)}return t}static detectScenes(e,t){const o=[],s=e.split(`

`).filter(i=>i.trim().length>0);let r=null,a=[],c=0;for(const i of s)(this.isSceneBreak(i)||a.length>=4&&Math.random()>.7)&&a.length>0?(r&&(r.content=a.join(`

`),o.push(r)),c++,r={id:`${t}_scene_${c}`,chapterId:t,sceneNumber:c,content:"",setting:this.extractSetting(i),characters:this.extractCharacterMentions(i)},a=[i]):(r||(c++,r={id:`${t}_scene_${c}`,chapterId:t,sceneNumber:c,content:"",setting:this.extractSetting(i),characters:this.extractCharacterMentions(i)}),a.push(i));return r&&a.length>0&&(r.content=a.join(`

`),o.push(r)),o}static isSceneBreak(e){return[/^-{3,}$/,/^\*{3,}$/,/^#{3,}$/,/^ç¬¬.*èŠ‚/,/^Scene\s+\d+/i,/^[0-9]+\./].some(o=>o.test(e.trim()))}static extractSetting(e){const t=[/åœ¨(.{1,20}?)(?:ï¼Œ|ã€‚|é‡Œ|ä¸­|å†…)/,/(?:æ¥åˆ°|èµ°è¿›|è¿›å…¥)(.{1,20}?)(?:ï¼Œ|ã€‚)/,/(.{1,20}?)(?:æˆ¿é—´|å¤§å…|åŠå…¬å®¤|å­¦æ ¡|åŒ»é™¢|å…¬å›­)/];for(const o of t){const s=e.match(o);if(s)return s[1].trim()}return"Unknown"}static extractCharacterMentions(e){const t=[],o=/[ç‹æå¼ åˆ˜é™ˆæ¨é»„èµµå´å‘¨å¾å­™é©¬æœ±èƒ¡éƒ­ä½•é«˜æ—ç½—éƒ‘æ¢è°¢å®‹å”è®¸éŸ©å†¯é‚“æ›¹å½­æ›¾è§ç”°è‘£è¢æ½˜äºè’‹è”¡ä½™æœå¶ç¨‹è‹é­å•ä¸ä»»æ²ˆå§šå¢å§œå´”é’Ÿè°­é™†æ±ªèŒƒé‡‘çŸ³å»–è´¾å¤éŸ¦ä»˜æ–¹ç™½é‚¹å­Ÿç†Šç§¦é‚±æ±Ÿå°¹è–›é—«æ®µé›·ä¾¯é¾™å²é™¶é»è´ºé¡¾æ¯›éƒé¾šé‚µä¸‡é’±ä¸¥è¦ƒæ­¦æˆ´è«å­”å‘æ±¤][\u4e00-\u9fa5]{1,2}/g,s=/\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?\b/g,r=e.match(o);if(r){const c=r.filter(i=>i.length<=3&&!i.endsWith("èµ°")&&!i.endsWith("è¿›")&&!i.endsWith("çœ‹")&&!i.endsWith("æ­£")&&!i.endsWith("åœ¨")&&!i.endsWith("ä¹Ÿ")&&!i.endsWith("äº†")&&!i.endsWith("çš„")&&!i.endsWith("æ˜¯")&&!i.endsWith("åˆ°")&&!i.endsWith("ç­‰"));t.push(...c)}const a=e.match(s);if(a){const c=["The","This","That","Chapter","Scene","When","Where","What","How","Why","And","But","For","With","From"],i=a.filter(l=>!c.includes(l));t.push(...i)}return[...new Set(t)]}static async parseNovel(e,t,o){const s=this.validateFile(e);if(!s.isValid)throw new Error(`File validation failed: ${s.errors.map(u=>u.message).join(", ")}`);const r=await this.extractTextContent(e),a=this.detectChapterBoundaries(r),i={wordCount:this.countWords(r),language:this.detectLanguage(r),description:this.generateDescription(r)};return{title:t||this.extractTitleFromFilename(e.name),author:o||"Unknown Author",chapters:a,metadata:i}}static async storeNovelStructure(e){const t=`novel_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o={id:t,...e,createdDate:new Date().toISOString(),lastUpdated:new Date().toISOString()};localStorage.setItem(`novel_${t}`,JSON.stringify(o));const s=this.getStoredNovelsList();return s.push({id:t,title:e.title,author:e.author,wordCount:e.metadata.wordCount,createdDate:o.createdDate}),localStorage.setItem("novels_list",JSON.stringify(s)),t}static async retrieveNovelStructure(e){const t=localStorage.getItem(`novel_${e}`);if(!t)return null;try{const o=JSON.parse(t),{id:s,createdDate:r,lastUpdated:a,...c}=o;return c}catch(o){return console.error("Failed to parse stored novel:",o),null}}static validateContentIntegrity(e){const t=[],o=[];(!e.title||e.title.trim().length===0)&&t.push({code:"MISSING_TITLE",message:"Novel title is required",field:"title",severity:"error"}),(!e.author||e.author.trim().length===0)&&o.push({code:"MISSING_AUTHOR",message:"Author information is missing",field:"author",severity:"warning"}),(!e.chapters||e.chapters.length===0)&&t.push({code:"NO_CHAPTERS",message:"Novel must contain at least one chapter",field:"chapters",severity:"error"}),e.chapters.forEach((r,a)=>{(!r.content||r.content.trim().length===0)&&t.push({code:"EMPTY_CHAPTER",message:`Chapter ${a+1} is empty`,field:`chapters[${a}].content`,severity:"error"}),r.wordCount!==this.countWords(r.content)&&o.push({code:"WORD_COUNT_MISMATCH",message:`Chapter ${a+1} word count may be incorrect`,field:`chapters[${a}].wordCount`,severity:"warning"})});const s=e.chapters.reduce((r,a)=>r+a.wordCount,0);return Math.abs(s-e.metadata.wordCount)>10&&o.push({code:"TOTAL_WORD_COUNT_MISMATCH",message:"Total word count may be incorrect",field:"metadata.wordCount",severity:"warning"}),{isValid:t.length===0,errors:t,warnings:o}}static getFileExtension(e){return e.toLowerCase().substring(e.lastIndexOf("."))}static formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(2))+" "+o[s]}static countWords(e){if(!e)return 0;const t=(e.match(/[\u4e00-\u9fa5]/g)||[]).length,o=e.replace(/[\u4e00-\u9fa5]/g,"").match(/\b\w+\b/g)?.length||0;return t+o}static detectLanguage(e){const t=(e.match(/[\u4e00-\u9fa5]/g)||[]).length,o=e.length;return t/o>.3?"zh":"en"}static generateDescription(e){const o=e.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s=>s.trim().length>0).slice(0,3).join("ã€‚");return o.length>200?o.substring(0,200)+"...":o}static extractTitleFromFilename(e){return e.replace(/\.[^/.]+$/,"").replace(/[_-]/g," ")}static getStoredNovelsList(){const e=localStorage.getItem("novels_list");return e?JSON.parse(e):[]}}class M{constructor(){this.executions=new Map,this.progressCallbacks=new Map,this.nodeProcessors=new Map,this.activeExecutions=0,this.maxConcurrentExecutions=3,this.initializeNodeProcessors()}async executeWorkflow(e,t={},o={}){const s=`execution_${Date.now()}_${Math.random().toString(36).substring(2,11)}`;console.log("ğŸš€ [PipelineOrchestrator] Starting workflow execution:",{executionId:s,workflowId:e.id,workflowName:e.name,nodeCount:e.nodes?.length||0,connectionCount:e.connections?.length||0,initialDataKeys:Object.keys(t)});const r={id:s,workflowId:e.id,status:"running",startTime:new Date,progress:0,context:{executionId:s,workflow:e,data:t,nodeResults:new Map,errors:[],warnings:[]},options:{parallelExecution:o.parallelExecution??!0,maxRetries:o.maxRetries??3,timeout:o.timeout,errorHandling:o.errorHandling??"stop"}};return this.executions.set(s,r),await this.startExecution(r),s}monitorProgress(e,t){this.progressCallbacks.set(e,t)}getExecutionStatus(e){return this.executions.get(e)||null}cancelExecution(e){const t=this.executions.get(e);return!t||["completed","failed","cancelled"].includes(t.status)?!1:(t.status="cancelled",t.endTime=new Date,this.notifyProgress(e,{pipelineId:e,status:"cancelled",progress:t.progress,message:"ç”¨æˆ·å–æ¶ˆæ‰§è¡Œ"}),!0)}async startExecution(e){try{await this.executeNodes(e)}catch(t){this.handleExecutionError(e,t)}}async executeNodes(e){const{workflow:t}=e.context,o=new Set;console.log("ğŸ”„ [PipelineOrchestrator] executeNodes called:",{workflowId:t.id,nodeCount:t.nodes?.length||0,connectionCount:t.connections?.length||0});const s=this.findStartingNodes(t);if(console.log("ğŸ¯ [PipelineOrchestrator] Starting nodes found:",s.map(r=>({id:r.id,name:r.name,type:r.type}))),s.length===0)throw console.error("âŒ [PipelineOrchestrator] No starting nodes found!"),console.log("ğŸ“‹ All nodes:",t.nodes?.map(r=>({id:r.id,name:r.name,type:r.type}))),console.log("ğŸ”— All connections:",t.connections),new Error("No starting nodes found in workflow");for(const r of s)console.log("â–¶ï¸ [PipelineOrchestrator] Executing node chain starting from:",r.name),await this.executeNodeChain(e,r,o);console.log("âœ… [PipelineOrchestrator] All nodes executed:",o.size),e.status="completed",e.endTime=new Date,e.progress=100,this.notifyProgress(e.id,{pipelineId:e.id,status:"completed",progress:100,message:"å·¥ä½œæµæ‰§è¡Œå®Œæˆ"})}async executeNodeChain(e,t,o){if(!(o.has(t.id)||e.status!=="running"))try{this.notifyProgress(e.id,{pipelineId:e.id,status:"running",progress:e.progress,message:`æ­£åœ¨æ‰§è¡Œ: ${t.name}`,currentNode:t.id});const s=await this.executeNode(e.context,t);e.context.nodeResults.set(t.id,s),o.add(t.id),e.progress=Math.round(o.size/e.context.workflow.nodes.length*100);const r=this.getNodeDependents(e.context.workflow,t.id);for(const a of r)await this.executeNodeChain(e,a,o)}catch(s){await this.handleNodeError(e,t,s)}}async executeNode(e,t){const o=this.nodeProcessors.get(t.type);if(!o)throw new Error(`No processor found for node type: ${t.type}`);return o(e,t)}handleExecutionError(e,t){e.status="failed",e.endTime=new Date,e.context.errors.push({error:t.message||t,timestamp:new Date}),this.notifyProgress(e.id,{pipelineId:e.id,status:"failed",progress:e.progress,message:"æ‰§è¡Œå¤±è´¥",error:t.message})}async handleNodeError(e,t,o){const s={nodeId:t.id,nodeName:t.name,error:o.message||o,timestamp:new Date};e.context.errors.push(s),e.options.errorHandling==="stop"&&(e.status="failed",e.endTime=new Date,this.notifyProgress(e.id,{pipelineId:e.id,status:"failed",progress:e.progress,message:`èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: ${t.name}`,error:o.message}))}notifyProgress(e,t){const o=this.progressCallbacks.get(e);o&&o(t)}findStartingNodes(e){const t=new Set;return e.connections.forEach(o=>{t.add(o.toNodeId)}),e.nodes.filter(o=>!t.has(o.id))}getNodeDependents(e,t){const o=e.connections.filter(s=>s.fromNodeId===t).map(s=>s.toNodeId);return e.nodes.filter(s=>o.includes(s.id))}initializeNodeProcessors(){this.nodeProcessors.set("novel-parser",async(e,t)=>{const{data:o}=e;if(console.log("ğŸ“– å°è¯´è§£æå™¨ - åˆå§‹æ•°æ®:",{hasFile:!!o.file,hasNovelId:!!o.novelId,hasChapters:!!(o.chapters&&o.chapters.length>0)}),o.chapters&&o.chapters.length>0)return console.log("âœ… ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„ç« èŠ‚æ•°æ®:",o.chapters.length,"ç« "),{novelId:o.novelId,title:o.title||"æœªå‘½åå°è¯´",author:o.author||"æœªçŸ¥ä½œè€…",chapters:o.chapters,metadata:o.metadata||{},text:o.chapters.map(r=>r.content||"").join(`

`),structure:{chapterCount:o.chapters.length,totalScenes:o.chapters.reduce((r,a)=>r+(a.scenes?.length||0),0)}};if(o.file){console.log("ğŸ“‚ è§£æä¸Šä¼ çš„æ–‡ä»¶...");const r=await w.parseNovel(o.file,o.title),a=await w.storeNovelStructure(r);return console.log("âœ… æ–‡ä»¶è§£æå®Œæˆ:",r.chapters.length,"ç« "),{novelId:a,title:r.title,author:r.author,chapters:r.chapters,metadata:r.metadata,text:r.chapters.map(c=>c.content).join(`

`),structure:{chapterCount:r.chapters.length,totalScenes:r.chapters.reduce((c,i)=>c+(i.scenes?.length||0),0)}}}console.log("ğŸ“‚ [PipelineOrchestrator] å°è¯•åŠ è½½å°è¯´æ•°æ®");let s=o.novelId;if(!s){const r=localStorage.getItem("novel_anime_current_novel_id");r&&(s=r,console.log("ğŸ“¦ [æ–¹å¼0] ä» localStorage è·å–åˆ°æœ€æ–° novelId:",s))}if(s){console.log("ğŸ“‚ [PipelineOrchestrator] ä½¿ç”¨ novelId:",s),console.log("ğŸ“¦ [æ–¹å¼1] å°è¯•ä» NovelParser localStorage åŠ è½½...");const r=await w.retrieveNovelStructure(s);if(r&&r.chapters&&r.chapters.length>0)return console.log("âœ… ä» NovelParser localStorage åŠ è½½æˆåŠŸ:",r.chapters.length,"ç« "),{novelId:s,title:r.title,author:r.author,chapters:r.chapters,metadata:r.metadata,text:r.chapters.map(a=>a.content).join(`

`),structure:{chapterCount:r.chapters.length,totalScenes:r.chapters.reduce((a,c)=>a+(c.scenes?.length||0),0)}};console.log("âš ï¸ NovelParser localStorage æ— æ•°æ®"),console.log("ğŸ“¦ [æ–¹å¼2] å°è¯•ä» localStorage (novel_ å‰ç¼€) åŠ è½½...");try{const a=localStorage.getItem(`novel_${s}`);if(a){const c=JSON.parse(a);if(c.chapters&&c.chapters.length>0)return console.log("âœ… ä» localStorage (novel_ å‰ç¼€) åŠ è½½æˆåŠŸ:",c.chapters.length,"ç« "),{novelId:s,title:c.title,author:c.author,chapters:c.chapters,metadata:c.metadata||{},text:c.chapters.map(i=>i.content||"").join(`

`),structure:{chapterCount:c.chapters.length,totalScenes:c.chapters.reduce((i,l)=>i+(l.scenes?.length||0),0)}}}}catch(a){console.warn("âš ï¸ localStorage (novel_ å‰ç¼€) åŠ è½½å¤±è´¥:",a)}console.log("âš ï¸ localStorage (novel_ å‰ç¼€) æ— æ•°æ®"),console.log("ğŸ“¡ [æ–¹å¼3] å°è¯•ä»åç«¯ API åŠ è½½... URL: /novel/"+s);try{const a=await f.getNovel(s);if(console.log("ğŸ“¡ åç«¯ API å“åº”:",{success:a.success,hasNovel:!!a.novel,message:a.message}),a.success&&a.novel){const c=a.novel;if(console.log("âœ… ä»åç«¯ API åŠ è½½æˆåŠŸ:",c.title,"- ç« èŠ‚æ•°:",c.chapters?.length||0),!c.chapters||c.chapters.length===0){console.log("ğŸ“Š å°è¯´æ²¡æœ‰ç« èŠ‚æ•°æ®ï¼Œå°è¯•è°ƒç”¨ç»“æ„åˆ†æ API...");try{const i=await f.axiosInstance.post("/novels/analyze-structure",{novelId:s});if(console.log("ğŸ“Š ç»“æ„åˆ†æå“åº”:",i.data),i.data.success||i.data.chaptersCreated>0){console.log("ğŸ”„ é‡æ–°è·å–å°è¯´æ•°æ®...");const l=await f.getNovel(s);if(l.success&&l.novel?.chapters?.length>0){const u=l.novel;console.log("âœ… ç»“æ„åˆ†æåè·å–åˆ°ç« èŠ‚:",u.chapters.length,"ç« ");const d={id:s,title:u.title,author:u.author,chapters:u.chapters,metadata:{wordCount:u.wordCount,status:u.status,sourceType:u.sourceType}};try{localStorage.setItem(`novel_${s}`,JSON.stringify(d)),console.log("ğŸ’¾ å·²å°†å°è¯´æ•°æ®ç¼“å­˜åˆ° localStorage")}catch(h){console.warn("âš ï¸ ç¼“å­˜åˆ° localStorage å¤±è´¥:",h)}return{novelId:s,title:u.title,author:u.author,chapters:u.chapters,metadata:d.metadata,text:u.chapters.map(h=>h.content||"").join(`

`),structure:{chapterCount:u.chapters.length,totalScenes:u.chapters.reduce((h,g)=>h+(g.scenes?.length||0),0)}}}}}catch(i){console.error("âŒ ç»“æ„åˆ†æ API è¯·æ±‚å¤±è´¥:",i)}}if(c.chapters&&c.chapters.length>0){const i={id:s,title:c.title,author:c.author,chapters:c.chapters,metadata:{wordCount:c.wordCount,status:c.status,sourceType:c.sourceType}};try{localStorage.setItem(`novel_${s}`,JSON.stringify(i)),console.log("ğŸ’¾ å·²å°†å°è¯´æ•°æ®ç¼“å­˜åˆ° localStorage")}catch(l){console.warn("âš ï¸ ç¼“å­˜åˆ° localStorage å¤±è´¥:",l)}return{novelId:s,title:c.title,author:c.author,chapters:c.chapters,metadata:i.metadata,text:c.chapters.map(l=>l.content||"").join(`

`),structure:{chapterCount:c.chapters.length,totalScenes:c.chapters.reduce((l,u)=>l+(u.scenes?.length||0),0)}}}else console.warn("âš ï¸ åç«¯è¿”å›çš„å°è¯´æ²¡æœ‰ç« èŠ‚æ•°æ®, novel:",JSON.stringify(c,null,2))}else console.warn("âš ï¸ åç«¯ API åŠ è½½å¤±è´¥:",a.message)}catch(a){console.error("âŒ åç«¯ API è¯·æ±‚å¤±è´¥:",a)}}throw new Error("æ— æ³•åŠ è½½å°è¯´æ•°æ®ï¼šè¯·ç¡®ä¿å·²ä¸Šä¼ å°è¯´æ–‡ä»¶æˆ–é€‰æ‹©äº†æœ‰æ•ˆçš„é¡¹ç›®")}),this.nodeProcessors.set("character-analyzer",async(e,t)=>{const s=this.getPreviousNodeResults(e,t)?.chapters||[];if(console.log("ğŸ” è§’è‰²åˆ†æå™¨ - æ”¶åˆ°ç« èŠ‚æ•°æ®:",s.length,"ç« "),s.length>0&&s.some(a=>a.content||a.scenes&&a.scenes.length>0)){console.log("âœ… ä½¿ç”¨çœŸå®ç« èŠ‚æ•°æ®è¿›è¡Œè§’è‰²åˆ†æ");let a=s;const c=e.data?.novelId;if(c)try{console.log("ğŸ¤– è°ƒç”¨åç«¯ AI æœåŠ¡è¿›è¡Œæ™ºèƒ½åœºæ™¯åˆ†å‰²...");const i=await f.axiosInstance.post("/novels/analyze-structure",{novelId:c});if(i.data?.success){console.log("âœ… åç«¯ AI åˆ†æå®Œæˆ:",i.data);const l=await f.getNovel(c);l.success&&l.novel?.chapters?.length>0&&(a=l.novel.chapters.map(u=>({...u,id:u.chapterId||u.id,scenes:(u.scenes||[]).map((d,h)=>({id:d.sceneId||`${u.chapterId}_scene_${h+1}`,chapterId:u.chapterId||u.id,sceneNumber:d.sceneNumber||h+1,content:d.content||d.visualDescription||"",title:d.title||this.generateSceneTitle(d.content||"",u.title,h+1),setting:d.setting||this.inferSetting(d.content||""),mood:d.mood||"ä¸­æ€§",characters:d.characters||this.extractCharactersFromText(d.content||"")}))})),console.log("âœ… ä»åç«¯è·å–åˆ° AI åˆ†æåçš„ç« èŠ‚æ•°æ®:",a.length,"ç« "))}}catch(i){console.warn("âš ï¸ åç«¯ AI åˆ†æå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ™ºèƒ½åˆ†å‰²:",i.message)}a=a.map((i,l)=>{if(!i.scenes||i.scenes.length===0){const u=this.splitChapterIntoScenes(i,l);return{...i,scenes:u}}return i});try{const i=p.identifyCharacters(a);console.log("ğŸ“Š è¯†åˆ«åˆ°è§’è‰²:",i.length,"ä¸ª");const l=p.trackRecurringCharacters(i,a),u=l.filter(d=>d.role==="protagonist"||d.role==="antagonist");for(const d of u)p.createLockedProfile(d);return{chapters:a,characters:l.map(d=>({id:d.id,name:d.name,role:d.role,description:d.attributes?.personality||"",appearance:d.attributes?.appearance||"",relationships:d.relationships||[]})),relationships:l.flatMap(d=>d.relationships.map(h=>`${d.name}-${h.toCharacterId}: ${h.relationshipType}`)),statistics:{total:l.length,protagonists:l.filter(d=>d.role==="protagonist").length,antagonists:l.filter(d=>d.role==="antagonist").length,supporting:l.filter(d=>d.role==="supporting").length,minor:l.filter(d=>d.role==="minor").length}}}catch(i){throw console.error("âŒ è§’è‰²åˆ†æå¤±è´¥:",i),new Error(`è§’è‰²åˆ†æå¤±è´¥: ${i.message}`)}}throw new Error("è§’è‰²åˆ†æå¤±è´¥ï¼šæ²¡æœ‰æœ‰æ•ˆçš„ç« èŠ‚å†…å®¹ï¼Œè¯·ç¡®ä¿å°è¯´å·²æ­£ç¡®è§£æ")}),this.nodeProcessors.set("scene-generator",async(e,t)=>{const o=this.getPreviousNodeResults(e,t),s=o?.chapters||[],r=o?.characters||[];console.log("ğŸ¬ åœºæ™¯ç”Ÿæˆå™¨ - æ”¶åˆ°ç« èŠ‚æ•°æ®:",s.length,"ç« , è§’è‰²:",r.length,"ä¸ª");const a=[];let c=0;for(const i of s)if(i.scenes&&i.scenes.length>0)for(const l of i.scenes)c++,a.push({id:c,chapterId:i.id,title:`åœºæ™¯ ${c}`,description:l.content?.substring(0,100)+"...",setting:l.setting||"æœªçŸ¥åœºæ™¯",characters:l.characters||[],content:l.content});else i.content&&(c++,a.push({id:c,chapterId:i.id,title:i.title||`åœºæ™¯ ${c}`,description:i.content.substring(0,100)+"...",setting:"æœªçŸ¥åœºæ™¯",characters:[],content:i.content}));if(a.length===0)throw new Error("åœºæ™¯ç”Ÿæˆå¤±è´¥ï¼šæ²¡æœ‰æœ‰æ•ˆçš„åœºæ™¯æ•°æ®ï¼Œè¯·ç¡®ä¿ç« èŠ‚å·²æ­£ç¡®åˆ†æ");return console.log("âœ… ç”Ÿæˆäº†",a.length,"ä¸ªåœºæ™¯"),{chapters:s,characters:r,scenes:a,totalScenes:a.length}}),this.nodeProcessors.set("script-converter",async(e,t)=>{const o=this.getPreviousNodeResults(e,t),s=o?.scenes||[],r=o?.characters||[];console.log("ğŸ“ è„šæœ¬è½¬æ¢å™¨ - æ”¶åˆ°åœºæ™¯æ•°æ®:",s.length,"ä¸ªåœºæ™¯");const a=s.map((c,i)=>({id:`script_${i+1}`,sceneId:c.id,title:c.title,content:this.convertToScriptFormat(c),dialogues:this.extractDialogues(c.content||c.description)}));if(a.length===0)throw new Error("è„šæœ¬è½¬æ¢å¤±è´¥ï¼šæ²¡æœ‰æœ‰æ•ˆçš„åœºæ™¯æ•°æ®ï¼Œè¯·ç¡®ä¿åœºæ™¯å·²æ­£ç¡®ç”Ÿæˆ");return console.log("âœ… ç”Ÿæˆäº†",a.length,"ä¸ªè„šæœ¬"),{characters:r,scripts:a,totalScripts:a.length,dialogues:a.flatMap(c=>c.dialogues)}}),this.nodeProcessors.set("video-generator",async(e,t)=>{const o=this.getPreviousNodeResults(e,t),s=o?.scripts||[],r=o?.chapters||[],a=o?.characters||[],c=o?.scenes||[];if(console.log("ğŸ¥ è§†é¢‘ç”Ÿæˆå™¨ - æ”¶åˆ°è„šæœ¬æ•°æ®:",s.length,"ä¸ªè„šæœ¬"),s.length===0)throw new Error("è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼šæ²¡æœ‰æœ‰æ•ˆçš„è„šæœ¬æ•°æ®ï¼Œè¯·ç¡®ä¿è„šæœ¬å·²æ­£ç¡®è½¬æ¢");const i=s.map((l,u)=>({id:`video_task_${u+1}`,scriptId:l.id||`script_${u+1}`,title:l.title,status:"pending",content:l.content,dialogues:l.dialogues}));return console.log("âœ… åˆ›å»ºäº†",i.length,"ä¸ªè§†é¢‘ç”Ÿæˆä»»åŠ¡"),{chapters:r,characters:a,scenes:c,scripts:s,videoTasks:i,totalTasks:i.length,metadata:{status:"tasks_created",message:"è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾… AI è§†é¢‘æœåŠ¡å¤„ç†",resolution:"1080p",format:"mp4"}}}),this.nodeProcessors.set("image-generator",async(e,t)=>{const o=this.getPreviousNodeResults(e,t),s=o?.scenes||[],r=o?.scripts||[],a=o?.chapters||[],c=o?.characters||[];console.log("ğŸ¨ å›¾ç‰‡ç”Ÿæˆå™¨ - æ”¶åˆ°åœºæ™¯æ•°æ®:",s.length,"ä¸ªåœºæ™¯");const{imageGenerationService:i}=await x(async()=>{const{imageGenerationService:u}=await import("./ImageGenerationService-5Ehzbncq.js");return{imageGenerationService:u}},[],import.meta.url),l=[];for(let u=0;u<s.length;u++){const d=s[u];try{const h=this.buildImagePrompt(d,c);console.log(`ğŸ¨ ç”Ÿæˆåˆ†é•œ ${u+1}/${s.length}:`,h.substring(0,50)+"...");const g=await i.generateImage({prompt:h,width:800,height:450});l.push({id:`storyboard_${u+1}`,sceneId:d.id,description:d.content?.substring(0,200)||d.description||"",imageUrl:g.imageUrl,thumbnailUrl:g.thumbnailUrl,dialogue:this.extractFirstDialogue(d.content||""),speaker:this.extractSpeaker(d.content||""),duration:3e3,prompt:h,generatedAt:g.generatedAt}),console.log(`âœ… åˆ†é•œ ${u+1} ç”Ÿæˆå®Œæˆ`)}catch(h){console.error(`âŒ åˆ†é•œ ${u+1} ç”Ÿæˆå¤±è´¥:`,h),l.push({id:`storyboard_${u+1}`,sceneId:d.id,description:d.content?.substring(0,200)||d.description||"",imageUrl:void 0,thumbnailUrl:void 0,dialogue:this.extractFirstDialogue(d.content||""),speaker:this.extractSpeaker(d.content||""),duration:3e3})}}return console.log("âœ… ç”Ÿæˆäº†",l.length,"ä¸ªåˆ†é•œå›¾ç‰‡"),{chapters:a,characters:c,scenes:s,scripts:r,storyboards:l,totalStoryboards:l.length,metadata:{status:"images_generated",message:`æˆåŠŸç”Ÿæˆ ${l.length} ä¸ªåˆ†é•œå›¾ç‰‡`,provider:i.getConfig().provider}}})}getPreviousNodeResults(e,t){const{workflow:o,nodeResults:s}=e,r=o.connections.filter(c=>c.toNodeId===t.id),a={};for(const c of r){const i=s.get(c.fromNodeId);i&&Object.assign(a,i)}return a}convertToScriptFormat(e){const t=[];return t.push(`ã€åœºæ™¯ã€‘${e.title||"æœªå‘½ååœºæ™¯"}`),t.push(`ã€åœ°ç‚¹ã€‘${e.setting||"æœªçŸ¥"}`),e.characters?.length>0&&t.push(`ã€äººç‰©ã€‘${e.characters.join("ã€")}`),t.push(""),t.push(e.description||e.content||""),t.join(`
`)}extractDialogues(e){if(!e)return[];const t=[/"([^"]+)"/g,/ã€Œ([^ã€]+)ã€/g,/"([^"]+)"/g],o=[];for(const s of t){let r;for(;(r=s.exec(e))!==null;)o.push(r[1])}return o.slice(0,10)}splitChapterIntoScenes(e,t){const o=e.content||"";if(!o.trim())return[{id:`${e.id}_scene_1`,chapterId:e.id,sceneNumber:1,content:"",title:`${e.title||`ç¬¬${t+1}ç« `} - åœºæ™¯1`,setting:this.inferSetting(o),characters:[]}];const s=[],r=/\n\s*(?:\*{3,}|â€”{3,}|-{3,}|={3,}|Â·{3,})\s*\n/g;let a=o.split(r).filter(c=>c.trim());if(a.length<=1){const c=o.split(/\n\s*\n/).filter(i=>i.trim());if(c.length>3){const i=Math.ceil(c.length/Math.ceil(c.length/4));a=[];for(let l=0;l<c.length;l+=i)a.push(c.slice(l,l+i).join(`

`))}else a=[o]}return a.forEach((c,i)=>{const l=i+1,u=this.generateSceneTitle(c,e.title,l),d=this.inferSetting(c),h=this.extractCharactersFromText(c);s.push({id:`${e.id}_scene_${l}`,chapterId:e.id,sceneNumber:l,content:c.trim(),title:u,setting:d,characters:h})}),console.log(`ğŸ“– ç« èŠ‚ "${e.title}" åˆ†å‰²ä¸º ${s.length} ä¸ªåœºæ™¯`),s}generateSceneTitle(e,t,o){const s=e.split(`
`)[0]?.trim()||"";if(s.length>0&&s.length<30&&!s.includes('"')&&!s.includes("ã€Œ"))return s;const r=this.extractLocationKeywords(e);return r?`${r}`:`${t||"ç« èŠ‚"} - åœºæ™¯${o}`}inferSetting(e){if(!e)return"æœªçŸ¥åœºæ™¯";const t=[{pattern:/(?:åœ¨|åˆ°|æ¥åˆ°|èµ°è¿›|è¿›å…¥|å›åˆ°)([^ï¼Œã€‚ï¼ï¼Ÿ\n]{2,10}(?:é‡Œ|ä¸­|å†…|ä¸Š|ä¸‹|å‰|å|æ—))/,group:1},{pattern:/([^ï¼Œã€‚ï¼ï¼Ÿ\n]{2,8}(?:æˆ¿é—´|å®¢å…|å§å®¤|å¨æˆ¿|ä¹¦æˆ¿|åŠå…¬å®¤|æ•™å®¤|åŒ»é™¢|å­¦æ ¡|å…¬å¸|è¡—é“|å…¬å›­|å¹¿åœº|è½¦ç«™|æœºåœº|é…’åº—|é¤å…|å’–å•¡å…|å•†åœº|è¶…å¸‚|é“¶è¡Œ|å›¾ä¹¦é¦†))/,group:1},{pattern:/([^ï¼Œã€‚ï¼ï¼Ÿ\n]{2,6}(?:å±±|æ²³|æ¹–|æµ·|æ£®æ—|è‰åŸ|æ²™æ¼ |åŸå¸‚|æ‘åº„|å°é•‡))/,group:1},{pattern:/(?:å¤œæ™š|æ¸…æ™¨|é»„æ˜|å‚æ™š|åˆå|æ·±å¤œ)çš„([^ï¼Œã€‚ï¼ï¼Ÿ\n]{2,10})/,group:1}];for(const{pattern:s,group:r}of t){const a=e.match(s);if(a&&a[r])return a[r].trim()}const o=[/(?:é‚£å¤©|è¿™å¤©|å½“å¤©|ç¬¬äºŒå¤©|æ¬¡æ—¥|ç¿Œæ—¥)/,/(?:æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|å‚æ™š|æ™šä¸Š|æ·±å¤œ|å‡Œæ™¨)/,/(?:æ˜¥å¤©|å¤å¤©|ç§‹å¤©|å†¬å¤©|æ˜¥æ—¥|å¤æ—¥|ç§‹æ—¥|å†¬æ—¥)/];for(const s of o){const r=e.match(s);if(r)return r[0]}return"åœºæ™¯"}extractLocationKeywords(e){const t=e.match(/(?:åœ¨|åˆ°|æ¥åˆ°|èµ°è¿›|è¿›å…¥|å›åˆ°)([^ï¼Œã€‚ï¼ï¼Ÿ\n]{2,15})/);return t?t[1].trim():null}extractCharactersFromText(e){const t=new Set,o=[/([^\sï¼Œã€‚ï¼ï¼Ÿ""ã€Œã€]{2,4})(?:è¯´|é“|é—®|ç­”|å–Š|å«|ç¬‘|å“­|å¹)/g,/(?:^|[ã€‚ï¼ï¼Ÿ\n])([^\sï¼Œã€‚ï¼ï¼Ÿ""ã€Œã€]{2,4})(?:èµ°|è·‘|ç«™|å|çœ‹|å¬|æƒ³|è§‰å¾—|è®¤ä¸º|çŸ¥é“|å‘ç°)/g];for(const s of o){let r;for(;(r=s.exec(e))!==null;){const a=r[1].trim();!this.isCommonWord(a)&&a.length>=2&&t.add(a)}}return Array.from(t).slice(0,5)}isCommonWord(e){return["ä»–ä»¬","å¥¹ä»¬","æˆ‘ä»¬","ä½ ä»¬","å¤§å®¶","æ‰€æœ‰","è¿™ä¸ª","é‚£ä¸ª","ä»€ä¹ˆ","æ€ä¹ˆ","ä¸ºä»€ä¹ˆ","å“ªé‡Œ","è¿™é‡Œ","é‚£é‡Œ","ç°åœ¨","ç„¶å","ä½†æ˜¯","å› ä¸º","æ‰€ä»¥","å¦‚æœ","è™½ç„¶","ä¸è¿‡","è€Œä¸”","æˆ–è€…","ä¸€ä¸ª","ä¸¤ä¸ª","å‡ ä¸ª","å¾ˆå¤š","ä¸€äº›","è¿™äº›","é‚£äº›","è‡ªå·±","å¯¹æ–¹","åˆ«äºº","å…¶ä»–","æ‰€æœ‰äºº","æ²¡æœ‰äºº","æœ‰äºº","æ— äºº"].includes(e)}buildImagePrompt(e,t,o=0,s=""){const r=[];s&&r.push(`Chapter: ${s}`),r.push(`Scene ${o+1}`),e.title&&e.title!=="æœªå‘½ååœºæ™¯"&&r.push(e.title);const a=e.content||e.description||"";if(a){const i=this.extractVisualElements(a,200);i&&r.push(i)}if(e.setting&&e.setting!=="æœªçŸ¥åœºæ™¯"&&r.push(`Setting: ${e.setting}`),e.characters&&e.characters.length>0){const i=e.characters.slice(0,3).join(", ");r.push(`Characters: ${i}`)}(e.id||e.sceneId)&&r.push(`ID: ${e.id||e.sceneId}`),r.length===0&&r.push(`anime scene ${o+1}`);const c=r.join(", ");return console.log(`ğŸ¨ Scene ${o+1} prompt:`,c.substring(0,100)+"..."),c}extractVisualElements(e,t=100){if(!e)return"";const o=e.substring(0,t).trim();return o.replace(/"[^"]*"/g,"").trim()||o}generateSeedFromSceneId(e,t=0){if(e){if(typeof e=="number")return e;let o=0;for(let s=0;s<e.length;s++){const r=e.charCodeAt(s);o=(o<<5)-o+r,o=o&o}return Math.abs(o)}return 1e3+t}extractFirstDialogue(e){if(!e)return;const t=[/"([^"]+)"/,/ã€Œ([^ã€]+)ã€/,/"([^"]+)"/];for(const o of t){const s=e.match(o);if(s&&s[1])return s[1].trim()}}extractSpeaker(e){if(!e)return;const t=[/([^\sï¼Œã€‚ï¼ï¼Ÿ""ã€Œã€]{2,4})(?:è¯´|é“|é—®|ç­”|å–Š|å«)[:ï¼š]?"([^"]+)"/,/([^\sï¼Œã€‚ï¼ï¼Ÿ""ã€Œã€]{2,4})(?:è¯´|é“|é—®|ç­”|å–Š|å«)[:ï¼š]?ã€Œ([^ã€]+)ã€/];for(const o of t){const s=e.match(o);if(s&&s[1])return s[1].trim()}}}const b=W("workflow",{state:()=>({workflows:[],currentWorkflowId:null,executions:[],isExecuting:!1,executionProgress:0,executionStatus:"idle",executionMessage:"",isLoading:!1,isInitialized:!1,error:null,projectWorkflowMap:new Map,isCreatingWorkflowForProject:null}),getters:{currentWorkflow:n=>n.currentWorkflowId&&n.workflows.find(e=>e.id===n.currentWorkflowId)||null,workflowCount:n=>n.workflows.length,hasCurrentWorkflow:n=>n.currentWorkflowId!==null,currentWorkflowNodes(){return this.currentWorkflow?.nodes||[]},currentWorkflowConnections(){return this.currentWorkflow?.connections||[]},activeExecutions:n=>n.executions.filter(e=>e.status==="running"||e.status==="paused")},actions:{async initialize(){this.isInitialized||(this.loadProjectWorkflowMap(),await this.loadWorkflows(),this.isInitialized=!0)},async waitForInit(){this.isInitialized||await this.initialize()},async loadWorkflows(n){this.isLoading=!0,this.error=null;try{const e=await v(n?{projectId:n}:void 0);e.success&&e.data?(this.workflows=e.data.workflows,console.log("ğŸ“‚ loadWorkflows: loaded",this.workflows.length,"workflows",n?`for project ${n}`:"(all projects)")):this.error={code:"API_ERROR",message:e.message||"Failed to load workflows"}}catch(e){const t=e instanceof Error?e.message:"Unknown error";this.error={code:"UNKNOWN",message:t},console.error("[WorkflowStore] loadWorkflows failed:",t)}finally{this.isLoading=!1}},selectWorkflow(n){return this.workflows.some(t=>t.id===n)?(this.currentWorkflowId=n,console.log("ğŸ“Œ selectWorkflow:",n),!0):(console.warn("âš ï¸ selectWorkflow: workflow not found:",n),console.log("ğŸ“‹ Available workflows:",this.workflows.map(t=>({id:t.id,name:t.name}))),!1)},async createWorkflow(n){this.isLoading=!0,this.error=null;try{const e=this.workflows.map(s=>s.name),t=S(n.name,e),o=await N({name:t,description:n.description,projectId:n.projectId});if(o.success&&o.data?.workflow){const s=o.data.workflow;return this.workflows.push(s),n.projectId&&this.setProjectWorkflowMapping(n.projectId,s.id),console.log("âœ… createWorkflow:",s.name,n.projectId?`(projectId: ${n.projectId})`:""),s}else return this.error={code:"API_ERROR",message:o.message||"Failed to create workflow"},null}catch(e){const t=e instanceof Error?e.message:"Unknown error";return this.error={code:"UNKNOWN",message:t},console.error("[WorkflowStore] createWorkflow failed:",t),null}finally{this.isLoading=!1}},async deleteWorkflow(n){this.isLoading=!0,this.error=null;try{const e=await C(n);return e.success?(this.workflows=this.workflows.filter(t=>t.id!==n),this.currentWorkflowId===n&&(this.currentWorkflowId=null),console.log("ğŸ—‘ï¸ deleteWorkflow:",n),!0):(this.error={code:"API_ERROR",message:e.message||"Failed to delete workflow"},!1)}catch(e){const t=e instanceof Error?e.message:"Unknown error";return this.error={code:"UNKNOWN",message:t},console.error("[WorkflowStore] deleteWorkflow failed:",t),!1}finally{this.isLoading=!1}},async renameWorkflow(n,e){const t=this.workflows.find(r=>r.id===n);if(!t)return{success:!1,name:e};if(t.name===e)return{success:!0,name:e};const o=this.workflows.filter(r=>r.id!==n).map(r=>r.name),s=S(e,o);try{return(await k(n,{name:s})).success?(t.name=s,t.updatedAt=new Date().toISOString(),{success:!0,name:s}):{success:!1,name:e}}catch(r){return console.error("[WorkflowStore] renameWorkflow failed:",r),{success:!1,name:e}}},async saveWorkflow(n){const e=this.workflows.find(t=>t.id===n);if(!e)return!1;try{return(await k(n,{name:e.name,description:e.description,nodes:e.nodes,connections:e.connections,status:e.status})).success?(e.updatedAt=new Date().toISOString(),console.log("ğŸ’¾ saveWorkflow:",n),!0):!1}catch(t){return console.error("[WorkflowStore] saveWorkflow failed:",t),!1}},getWorkflowByProjectId(n){const e=this.projectWorkflowMap.get(n);if(e){const o=this.workflows.find(s=>s.id===e);if(o)return console.log("âœ… getWorkflowByProjectId: found in cache:",n,"->",e),o;console.log("âš ï¸ getWorkflowByProjectId: stale mapping detected, cleaning up"),this.projectWorkflowMap.delete(n),this.persistProjectWorkflowMap()}const t=this.workflows.find(o=>o.projectId===n);return t?(console.log("âœ… getWorkflowByProjectId: found by search:",n,"->",t.id),this.projectWorkflowMap.set(n,t.id),this.persistProjectWorkflowMap(),t):(console.log("âš ï¸ getWorkflowByProjectId: not found for project:",n),null)},setProjectWorkflowMapping(n,e){this.projectWorkflowMap.set(n,e),this.persistProjectWorkflowMap(),console.log("ğŸ“Œ setProjectWorkflowMapping:",n,"->",e)},clearProjectWorkflowMapping(n){this.projectWorkflowMap.delete(n),this.persistProjectWorkflowMap(),console.log("ğŸ—‘ï¸ clearProjectWorkflowMapping:",n)},persistProjectWorkflowMap(){try{const n=Object.fromEntries(this.projectWorkflowMap);localStorage.setItem("novel_anime_project_workflow_map",JSON.stringify(n)),console.log("ğŸ’¾ persistProjectWorkflowMap: saved",Object.keys(n).length,"mappings")}catch(n){console.error("âŒ persistProjectWorkflowMap failed:",n)}},loadProjectWorkflowMap(){try{const n=localStorage.getItem("novel_anime_project_workflow_map");if(n){const e=JSON.parse(n);this.projectWorkflowMap=new Map(Object.entries(e)),console.log("ğŸ“‚ loadProjectWorkflowMap: loaded",this.projectWorkflowMap.size,"mappings")}else console.log("ğŸ“‚ loadProjectWorkflowMap: no stored mappings found")}catch(n){console.error("âŒ loadProjectWorkflowMap failed:",n),this.projectWorkflowMap=new Map}},getNodeTitle(n){return{"novel-parser":"å°è¯´è§£æå™¨","character-analyzer":"è§’è‰²åˆ†æå™¨","scene-generator":"åœºæ™¯ç”Ÿæˆå™¨","script-converter":"è„šæœ¬è½¬æ¢å™¨","video-generator":"è§†é¢‘ç”Ÿæˆå™¨"}[n]||n},async addTemplateNodesToWorkflow(n,e){const t=[];e.nodes.forEach((o,s)=>{const r=this.addNode(n,o,this.getNodeTitle(o),{x:100+s*220,y:100});r&&t.push(r.id)});for(let o=0;o<t.length-1;o++)this.addConnection(n,t[o],t[o+1]);console.log("ğŸ“‹ addTemplateNodesToWorkflow: added",t.length,"nodes to workflow:",n)},async cleanupEmptyWorkflows(n){const e=this.workflows.filter(o=>{const s=!o.nodes||o.nodes.length===0,r=!n||o.projectId===n;return s&&r});let t=0;for(const o of e)await this.deleteWorkflow(o.id)&&(t++,console.log("ğŸ—‘ï¸ cleanupEmptyWorkflows: deleted empty workflow:",o.name));return t>0&&console.log("âœ… cleanupEmptyWorkflows: cleaned up",t,"empty workflow(s)"),t},async createWorkflowForProject(n,e,t){if(this.isCreatingWorkflowForProject===n)return console.log("â³ createWorkflowForProject: already creating for project:",n),null;const o=this.getWorkflowByProjectId(n);if(o)return console.log("âœ… createWorkflowForProject: workflow already exists for project:",n),(!o.nodes||o.nodes.length===0)&&(console.log("ğŸ“‹ createWorkflowForProject: adding template nodes to existing empty workflow"),await this.addTemplateNodesToWorkflow(o.id,e),await this.saveWorkflow(o.id)),o;this.isCreatingWorkflowForProject=n;try{const s=`${t} - ${e.name}`,r=await this.createWorkflow({name:s,description:e.description});if(!r)throw new Error("Failed to create workflow");return r.projectId=n,await this.addTemplateNodesToWorkflow(r.id,e),this.setProjectWorkflowMapping(n,r.id),await this.saveWorkflow(r.id),console.log("âœ… createWorkflowForProject: created workflow for project:",n,r.name),r}catch(s){throw console.error("âŒ createWorkflowForProject failed:",s),s}finally{this.isCreatingWorkflowForProject=null}},addNode(n,e,t,o,s={}){const r=this.workflows.find(i=>i.id===n);if(!r)return null;const c={id:P(),type:e,name:t,position:o,configuration:s,status:"idle"};return r.nodes.push(c),r.updatedAt=new Date().toISOString(),console.log("â• addNode:",c.name,"to workflow:",n),c},removeNode(n,e){const t=this.workflows.find(s=>s.id===n);if(!t)return!1;const o=t.nodes.findIndex(s=>s.id===e);return o===-1?!1:(t.nodes.splice(o,1),t.connections=t.connections.filter(s=>s.fromNodeId!==e&&s.toNodeId!==e),t.updatedAt=new Date().toISOString(),console.log("â– removeNode:",e,"from workflow:",n),!0)},updateNodePosition(n,e,t){const o=this.workflows.find(r=>r.id===n);if(!o)return!1;const s=o.nodes.find(r=>r.id===e);return s?(s.position=t,o.updatedAt=new Date().toISOString(),!0):!1},updateNodeName(n,e,t){const o=this.workflows.find(r=>r.id===n);if(!o)return!1;const s=o.nodes.find(r=>r.id===e);return s?(s.name=t,o.updatedAt=new Date().toISOString(),!0):!1},updateNodeConfig(n,e,t){const o=this.workflows.find(r=>r.id===n);if(!o)return!1;const s=o.nodes.find(r=>r.id===e);return s?(s.configuration={...s.configuration,...t},o.updatedAt=new Date().toISOString(),!0):!1},addConnection(n,e,t){const o=this.workflows.find(l=>l.id===n);if(!o)return null;const s=o.nodes.find(l=>l.id===e),r=o.nodes.find(l=>l.id===t);if(!s||!r||e===t||o.connections.some(l=>l.fromNodeId===e&&l.toNodeId===t))return null;const i={id:_(),fromNodeId:e,toNodeId:t};return o.connections.push(i),o.updatedAt=new Date().toISOString(),console.log("ğŸ”— addConnection:",e,"->",t),i},removeConnection(n,e){const t=this.workflows.find(s=>s.id===n);if(!t)return!1;const o=t.connections.findIndex(s=>s.id===e);return o===-1?!1:(t.connections.splice(o,1),t.updatedAt=new Date().toISOString(),console.log("ğŸ”— removeConnection:",e),!0)},validateCurrentWorkflow(){const n=this.currentWorkflow;return n?E(n):{isValid:!1,errors:[{message:"No workflow selected"}],warnings:[]}},exportWorkflow(n){const e=this.workflows.find(t=>t.id===n);return e?F(e):null},importWorkflow(n){const e=$(n);return e&&(this.workflows.push(e),console.log("ğŸ“¥ importWorkflow:",e.name)),e},async createDefaultWorkflow(){const n=await this.createWorkflow({name:"å°è¯´è½¬åŠ¨æ¼«æµç¨‹",description:"å°†å°è¯´è½¬æ¢ä¸ºåŠ¨æ¼«è§†é¢‘çš„æ ‡å‡†å·¥ä½œæµ"});if(!n)return null;const e=[{type:"novel-parser",name:"å°è¯´è§£æå™¨",x:50,y:100},{type:"character-analyzer",name:"è§’è‰²åˆ†æå™¨",x:250,y:100},{type:"scene-generator",name:"åœºæ™¯ç”Ÿæˆå™¨",x:450,y:100},{type:"script-converter",name:"è„šæœ¬è½¬æ¢å™¨",x:650,y:100},{type:"video-generator",name:"è§†é¢‘ç”Ÿæˆå™¨",x:850,y:100}],t=[];for(const o of e){const s=this.addNode(n.id,o.type,o.name,{x:o.x,y:o.y});s&&t.push(s)}for(let o=0;o<t.length-1;o++)this.addConnection(n.id,t[o].id,t[o+1].id);return await this.saveWorkflow(n.id),this.selectWorkflow(n.id),n},clearError(){this.error=null},resetExecution(){this.isExecuting=!1,this.executionProgress=0,this.executionStatus="idle",this.executionMessage="",this.error=null},async executeWorkflow(n,e={}){const t=this.workflows.find(r=>r.id===n);if(!t)throw new Error("å·¥ä½œæµä¸å­˜åœ¨");if(t.nodes.length===0)throw new Error("å·¥ä½œæµæ²¡æœ‰èŠ‚ç‚¹");const o=`exec_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s={id:o,workflowId:n,status:"running",progress:0,startTime:Date.now(),context:{initialData:e,nodeResults:new Map}};this.executions.push(s),this.isExecuting=!0,this.executionProgress=0,this.executionStatus="running",this.executionMessage="æ­£åœ¨åˆå§‹åŒ–...",t.status="running";try{const r=new M,a=await r.executeWorkflow(t,e,{parallelExecution:!1,maxRetries:3,errorHandling:"stop"});r.monitorProgress(a,i=>{if(console.log("ğŸ“Š Pipeline progress:",i),i.currentNode){const l=t.nodes.find(u=>u.id===i.currentNode);l&&(l.status=i.status==="running"?"running":i.status==="completed"?"completed":"idle")}this.executionProgress=i.progress||0,s.progress=this.executionProgress,this.executionMessage=i.message||"æ‰§è¡Œä¸­..."});let c=r.getExecutionStatus(a);for(;c&&c.status==="running";)await new Promise(i=>setTimeout(i,500)),c=r.getExecutionStatus(a);if(!c||c.status==="failed")throw new Error(c?.context?.errors?.[0]?.error||"æ‰§è¡Œå¤±è´¥");if(c.status==="cancelled")throw new Error("æ‰§è¡Œå·²å–æ¶ˆ");c.context?.nodeResults&&(s.context=s.context||{initialData:e,nodeResults:new Map},s.context.nodeResults=c.context.nodeResults,t.nodes.forEach(i=>{i.status="completed"})),s.status="completed",s.endTime=Date.now(),t.status="completed",this.executionStatus="completed",this.executionProgress=100,this.executionMessage="æ‰§è¡Œå®Œæˆ",this.isExecuting=!1,console.log("âœ… Workflow execution completed, nodeResults:",s.context?.nodeResults)}catch(r){throw s.status="failed",s.endTime=Date.now(),s.error=r instanceof Error?r.message:"æœªçŸ¥é”™è¯¯",t.status="failed",this.executionStatus="failed",this.executionMessage="æ‰§è¡Œå¤±è´¥",this.isExecuting=!1,t.nodes.forEach(a=>{a.status==="running"&&(a.status="idle")}),r}return o},cancelExecution(n){const e=this.executions.find(o=>o.id===n);if(!e||e.status!=="running")return!1;e.status="cancelled",e.endTime=Date.now();const t=this.workflows.find(o=>o.id===e.workflowId);return t&&(t.status="idle",t.nodes.forEach(o=>{o.status==="running"&&(o.status="idle")})),this.isExecuting=!1,this.executionStatus="idle",this.executionMessage="",!0},getExecutionStatus(n){return n&&this.executions.find(e=>e.id===n)||null},setCurrentWorkflow(n){return this.selectWorkflow(n)}}});export{b as useWorkflowStore};
