# Storyboard Creator Service

The Storyboard Creator is a core component of the Novel-to-Anime Video Generator that transforms screenplay content into detailed shot-by-shot visual descriptions for AI video generation. It bridges the gap between script format and visual production requirements.

## Overview

The Storyboard Creator takes screenplays generated by the Script Converter and creates comprehensive storyboards with shot specifications, camera angles, character positioning, and transition details. It ensures visual consistency while providing detailed guidance for AI video generation systems.

## Key Features

### 1. Shot-by-Shot Generation System
- **Scene Analysis**: Analyzes screenplay content to determine optimal shot sequences
- **Shot Type Selection**: Automatically selects appropriate shot types (wide, medium, close-up, etc.)
- **Camera Angle Specification**: Determines optimal camera angles based on scene content and emotional context
- **Duration Calculation**: Calculates appropriate shot durations based on content and shot type

### 2. Character Positioning and Composition
- **Character Placement**: Positions characters within shots based on shot type and scene requirements
- **Expression Generation**: Creates character expressions based on personality profiles
- **Action Specification**: Defines character actions appropriate for each shot
- **Prominence Management**: Manages character prominence (foreground, midground, background)

### 3. Visual Composition Details
- **Setting Integration**: Incorporates scene settings with appropriate lighting and atmosphere
- **Time-Based Lighting**: Generates lighting descriptions based on time of day and location
- **Atmosphere Creation**: Creates atmospheric descriptions based on scene content and mood
- **Visual Description**: Provides comprehensive visual descriptions for each shot

### 4. Advanced Transition Specification System
- **Intelligent Transition Selection**: Uses context-aware algorithms analyzing location, time, scale, angle, and emotional changes
- **Continuity Specifications**: Generates detailed video continuity specs including character positioning, lighting, motion, and audio continuity
- **Quality Validation**: Comprehensive transition quality assessment with scoring and actionable recommendations
- **Flow Analysis**: Analyzes overall transition flow, pacing, and density across the entire storyboard
- **Automatic Optimization**: Optimizes transitions for better quality scores and visual coherence
- **Context Analysis**: Analyzes transition context including location changes, time shifts, scale changes, angle changes, emotional shifts, character continuity, and narrative pace

### 5. Advanced AI Generation Compatibility System
- **Structured Data Output**: Generates comprehensive structured data compatible with multiple AI video generation platforms
- **Multi-Platform Support**: Supports RunwayML Gen-2, Pika Labs, Stable Video Diffusion, and Gen-2 with platform-specific formatting
- **Enhanced Prompt Generation**: Creates primary, detailed, negative, and style prompts for optimal AI generation results
- **Quality Validation**: Comprehensive compatibility validation with scoring, issue detection, and actionable recommendations
- **Format Validation**: Validates output format compatibility and provides platform-specific optimizations
- **Technical Specifications**: Includes all technical details needed for professional video production

## Core Methods

### `createStoryboard(screenplay, characters, lockedProfiles)`
Main method that creates a complete storyboard from screenplay content.

**Parameters:**
- `screenplay`: Screenplay object with scenes and content
- `characters`: Array of character objects with attributes
- `lockedProfiles`: Array of locked character profiles for consistency

**Returns:** Complete Storyboard object with shots, transitions, and specifications

### Shot Generation Methods

#### `generateShotsForScene(scene, characters, lockedProfiles, startingShotNumber)`
Generates all shots for a single scene including establishing, content, and closing shots.

#### `generateEstablishingShot(scene, characters, lockedProfiles, shotNumber)`
Creates establishing shots that set the scene context and location.

#### `generateContentShots(scene, characters, lockedProfiles, sceneAnalysis, startingShotNumber)`
Generates dialogue, action, and emotional shots based on scene content.

#### `generateClosingShot(scene, characters, lockedProfiles, shotNumber)`
Creates closing shots for scenes that need narrative conclusion.

### Analysis and Selection Methods

#### `analyzeSceneContent(scene, characters)`
Analyzes scene content to determine shot requirements and scene type.

#### `selectCameraAngle(shotType, sceneAnalysis)`
Selects appropriate camera angles based on shot type and scene context.

#### `calculateShotDuration(shotType, content)`
Calculates optimal shot duration based on type and content length.

### Character and Setting Methods

#### `positionCharactersInShot(characters, lockedProfiles, shotType)`
Positions characters within shots with appropriate expressions and actions.

#### `createSettingFromScene(scene)`
Creates comprehensive setting information from scene data.

#### `generateLighting(timeOfDay, location)`
Generates lighting descriptions based on time and location.

### Advanced Transition Methods

#### `generateShotTransition(fromShot, toShot)`
Creates intelligent transitions between individual shots with context analysis.

#### `generateSceneTransition(lastShot, nextShotNumber)`
Creates smooth transitions between scenes with continuity preservation.

#### `selectTransitionType(fromShot, toShot)`
Uses advanced algorithms to select optimal transition types based on comprehensive context analysis.

#### `analyzeTransitionContext(fromShot, toShot)`
Analyzes transition context including location changes, time changes, scale changes, angle changes, emotional shifts, character continuity, and narrative pace.

#### `applyTransitionRules(context, fromShot, toShot)`
Applies intelligent transition selection rules based on analyzed context.

#### `validateTransitionQuality(transition, fromShot, toShot)`
Validates transition quality and provides quality scores with detailed issues and recommendations.

#### `optimizeTransitions(transitions, shots)`
Optimizes all transitions in a storyboard for better quality and visual coherence.

#### `analyzeTransitionFlow(storyboard)`
Analyzes overall transition flow, pacing, and provides optimization suggestions for the entire storyboard.

#### `generateContinuitySpecifications(fromShot, toShot, transitionType)`
Generates detailed video continuity specifications including character positioning, lighting, motion, and audio continuity.

### AI Generation Compatibility Methods

#### `generateAICompatibleOutput(storyboard)`
Generates comprehensive structured data output for AI video generation systems with multi-platform compatibility.

#### `validateAICompatibility(aiData)`
Validates AI generation compatibility and provides quality scores with detailed issues and recommendations.

#### `formatForAIPlatform(aiData, platform)`
Formats storyboard data for specific AI platforms (RunwayML, Pika Labs, Stable Video, Gen-2) with platform-specific optimizations.

#### `convertShotToAIFormat(shot)`
Converts shot specifications to AI-compatible format with enhanced prompts and technical specifications.

#### `convertTransitionToAIFormat(transition)`
Converts transition specifications to AI-compatible format with detailed parameters.

#### `generateDetailedAIPrompt(shot)`
Generates enhanced AI prompts with comprehensive scene, character, and technical specifications.

#### `generateNegativePrompt(shot)`
Generates negative prompts to avoid unwanted elements in AI-generated videos.

#### `generateStylePrompt(shot)`
Generates style prompts for consistent visual style across AI-generated content.

## Shot Types and Specifications

### Supported Shot Types
- **Extreme Wide**: Establishing shots, environmental context (3-8 seconds)
- **Wide**: Scene setting, multiple characters (2-6 seconds)
- **Medium**: Character interaction, dialogue (2-5 seconds)
- **Close-up**: Emotional moments, single character focus (1-4 seconds)
- **Extreme Close-up**: Intense emotions, detail focus (0.5-2 seconds)
- **Over Shoulder**: Dialogue, conversation dynamics (2-5 seconds)

### Camera Angles
- **Eye Level**: Natural perspective, dialogue scenes (40% usage)
- **High Angle**: Vulnerability, overview shots (20% usage)
- **Low Angle**: Power, dominance, dramatic effect (15% usage)
- **Bird's Eye**: Establishing shots, spatial context (10% usage)
- **Worm's Eye**: Dramatic effect, unusual perspective (10% usage)
- **Dutch Angle**: Tension, unease, dynamic scenes (5% usage)

### Advanced Transition System

#### Transition Types with Intelligent Selection
- **Cut**: Direct transition, same location/time, fast-paced sequences (0s duration)
- **Fade**: Emotional transitions, dramatic shifts, scene changes (0.5-2.0s optimal: 1.0s)
- **Dissolve**: Location changes, time passage, major context shifts (1.0-3.0s optimal: 1.5s)
- **Wipe**: Dynamic transitions, subtle emotional shifts (0.5-1.5s optimal: 0.8s)
- **Zoom**: Scale changes, focus shifts, same location (0.8-2.0s optimal: 1.2s)
- **Pan**: Following movement, spatial continuity, character tracking (1.0-3.0s optimal: 2.0s)

#### Context-Aware Selection Rules
1. **Location/Time Changes**: Automatically use dissolve transitions
2. **Dramatic Emotional Shifts**: Apply fade transitions
3. **Major Scale Changes**: Implement zoom transitions
4. **Fast-Paced Action**: Use cut transitions
5. **Character Movement with Angle Changes**: Apply pan transitions
6. **Subtle Emotional Changes**: Use wipe transitions

#### Quality Validation Criteria
- **Transition Type Appropriateness**: Validates transition choice against context
- **Duration Optimization**: Ensures durations fall within optimal ranges
- **Continuity Preservation**: Validates character, lighting, and motion continuity
- **Visual Coherence**: Checks composition and atmosphere consistency

#### Continuity Specifications
- **Character Continuity**: Maintains character positioning with percentage-based continuity scores
- **Lighting Continuity**: Preserves or gradually adjusts lighting for time changes
- **Motion Continuity**: Follows character movement with appropriate camera work
- **Audio Continuity**: Manages dialogue and audio transitions (cross-fade, blend, maintain levels)

## Character Integration

### Character Positioning
- **Foreground**: Primary characters, main focus
- **Midground**: Secondary characters, supporting roles
- **Background**: Environmental characters, context

### Expression Generation
Based on character personality profiles:
- **Cheerful/Happy**: Smiling, bright eyes
- **Serious/Stern**: Focused, determined look
- **Shy/Timid**: Gentle, slightly averted gaze
- **Confident/Bold**: Confident, direct gaze

### Action Specification
Tailored to shot type and character personality:
- **Close-up shots**: Speaking or listening intently
- **Active personalities**: Animated gesturing
- **Calm personalities**: Standing calmly, relaxed posture
- **Nervous personalities**: Fidgeting slightly

## Setting and Atmosphere

### Time-Based Lighting
- **Dawn**: Soft golden light, long shadows
- **Morning**: Bright natural daylight, energetic
- **Noon**: Strong overhead lighting, minimal shadows
- **Afternoon**: Warm angled light, comfortable
- **Evening**: Golden hour lighting, intimate
- **Night**: Artificial lighting, dramatic shadows

### Atmosphere Generation
Based on scene content analysis:
- **Tense/Nervous**: Tense and suspenseful
- **Romantic/Love**: Romantic and intimate
- **Action/Fight**: Dynamic and energetic
- **Sad/Crying**: Melancholic and somber
- **Happy/Joy**: Cheerful and uplifting

## AI Prompt Generation

### Prompt Structure
1. **Technical Specifications**: Shot type, camera angle
2. **Setting and Atmosphere**: Location, time, mood
3. **Lighting**: Detailed lighting description
4. **Characters**: Position, expression, action
5. **Quality Standards**: High quality, cinematic, professional

### Example AI Prompt
```
wide shot, eye level camera angle, Living Room, morning, cheerful and uplifting, 
bright natural daylight, clear and energetic, indoor ambient lighting, 
character in center position, smiling bright eyes, natural relaxed posture, 
high quality, cinematic, detailed, professional animation
```

## Integration Points

### With Script Converter
- Receives Screenplay objects with formatted scenes
- Uses dialogue blocks and scene descriptions for shot planning
- Maintains character voice consistency in visual representation

### With Character System
- References locked character profiles for visual consistency
- Uses character attributes for expression and action generation
- Ensures character design consistency across shots

### With AI Video Generator
- Provides structured data compatible with AI systems
- Generates optimized prompts for video generation
- Includes all technical specifications needed for production

## Performance Considerations

### Optimization Features
- Efficient scene analysis algorithms
- Cached character positioning calculations
- Streamlined shot duration calculations
- Memory-efficient transition generation

### Scalability
- Handles screenplays with multiple scenes efficiently
- Processes large numbers of characters without performance degradation
- Supports concurrent storyboard generation for multiple episodes
- Memory-efficient processing of complex scene compositions

## Configuration Options

### Shot Duration Ranges
Configurable duration ranges for each shot type:
```typescript
SHOT_DURATION_RANGES = {
  'extreme_wide': { min: 3, max: 8 },
  'wide': { min: 2, max: 6 },
  'medium': { min: 2, max: 5 },
  'close_up': { min: 1, max: 4 },
  'extreme_close_up': { min: 0.5, max: 2 },
  'over_shoulder': { min: 2, max: 5 }
}
```

### Camera Angle Weights
Probability weights for camera angle selection:
```typescript
CAMERA_ANGLE_WEIGHTS = {
  'eye_level': 0.4,    // Most common
  'high': 0.2,         // For vulnerability
  'low': 0.15,         // For power
  'birds_eye': 0.1,    // For establishing
  'worms_eye': 0.1,    // For dramatic effect
  'dutch': 0.05        // For tension
}
```

### Shot Type Sequences
Predefined sequences for different scene types:
```typescript
SHOT_TYPE_SEQUENCES = {
  'establishing': ['extreme_wide', 'wide', 'medium'],
  'dialogue': ['medium', 'close_up', 'over_shoulder'],
  'action': ['wide', 'medium', 'close_up', 'extreme_close_up'],
  'emotional': ['close_up', 'extreme_close_up', 'medium'],
  'transition': ['wide', 'extreme_wide']
}
```

## Error Handling

### Input Validation
- Validates screenplay structure and content
- Handles missing or malformed character data
- Gracefully processes empty or minimal scenes

### Character Consistency
- Handles missing character profiles gracefully
- Provides default expressions and actions when profiles unavailable
- Maintains visual consistency across shots

### Shot Generation
- Ensures minimum shot requirements are met
- Handles scenes with varying character counts
- Provides fallback options for edge cases

## Testing Coverage

### Unit Tests (18 test cases)
- Complete storyboard creation from screenplay
- Shot generation with proper specifications
- Character positioning and composition
- Camera angle and shot type selection
- Transition generation and validation
- Edge case handling (empty scenes, missing characters, minimal content)

### Test Categories
- **Storyboard Creation**: Core functionality and output validation
- **Shot Generation**: Shot type variety and specification accuracy
- **Camera and Shot Selection**: Angle selection and duration calculation
- **Transition Generation**: Transition type selection and continuity
- **Edge Cases**: Robustness testing with various input conditions

## Usage Examples

### Basic Storyboard Creation
```typescript
const storyboard = StoryboardCreator.createStoryboard(screenplay, characters, lockedProfiles)
console.log(`Generated ${storyboard.shots.length} shots`)
console.log(`Total duration: ${storyboard.totalDuration} seconds`)
```

### Accessing Shot Details
```typescript
storyboard.shots.forEach(shot => {
  console.log(`Shot ${shot.shotNumber}: ${shot.shotType} (${shot.duration}s)`)
  console.log(`Camera: ${shot.cameraAngle}`)
  console.log(`Characters: ${shot.characters.length}`)
  console.log(`AI Prompt: ${shot.aiPrompt}`)
})
```

### Working with Transitions
```typescript
storyboard.transitionSpecs.forEach(transition => {
  console.log(`Transition: ${transition.transitionType} (${transition.duration}s)`)
  console.log(`From: ${transition.fromShotId} To: ${transition.toShotId}`)
})
```

## Future Enhancements

### Planned Features
- Advanced cinematography rules integration
- Dynamic shot selection based on narrative tension
- Enhanced character interaction positioning
- Support for complex multi-character scenes
- Integration with motion capture data

### Extensibility
- Pluggable shot selection algorithms
- Customizable transition rules
- Configurable camera movement specifications
- Extensible character positioning systems
- Custom AI prompt templates