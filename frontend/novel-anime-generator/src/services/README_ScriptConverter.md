# Script Converter Service

The Script Converter is a core component of the Novel-to-Anime Video Generator that transforms narrative prose into screenplay format with detailed scene descriptions. It bridges the gap between literary content and visual production requirements.

## Overview

The Script Converter takes episodes generated by the Episode Generator and converts them into properly formatted screenplays suitable for video production. It handles dialogue extraction, scene description generation, character voice consistency, and emotional beat translation.

## Key Features

### 1. Narrative to Screenplay Conversion
- **Prose Transformation**: Converts narrative text into standard screenplay format
- **Scene Heading Generation**: Creates properly formatted scene headings (INT./EXT. LOCATION - TIME)
- **Action Line Formatting**: Transforms narrative descriptions into present-tense action lines
- **Dialogue Formatting**: Extracts and formats dialogue with character names and directions

### 2. Dialogue Extraction and Processing
- **Multi-Pattern Recognition**: Supports various dialogue formats (quotes, single quotes, Japanese quotes)
- **Speaker Identification**: Automatically identifies dialogue speakers using character context
- **Emotional Context**: Extracts emotional undertones from dialogue context
- **Parenthetical Directions**: Captures and formats dialogue directions and emotions

### 3. Character Voice Consistency
- **Voice Pattern Analysis**: Validates dialogue consistency with character personalities
- **Verbosity Matching**: Ensures dialogue length matches character traits (terse vs. verbose)
- **Emotional Consistency**: Validates emotions align with character personalities
- **Cross-Scene Validation**: Maintains voice consistency across multiple scenes and episodes
- **Dialogue Pattern Recognition**: Analyzes sentence structure, vocabulary level, and formality
- **Speaking Style Preservation**: Maintains consistent contraction usage, question patterns, and exclamation usage
- **Voice Drift Detection**: Identifies and prevents character voice changes across episodes
- **Automatic Voice Adjustment**: Adjusts dialogue to maintain character consistency

### 4. Scene Description Generation
- **Visual Descriptions**: Creates detailed visual descriptions including setting, characters, and atmosphere
- **Action Descriptions**: Generates action-focused descriptions from narrative content
- **Mood Integration**: Incorporates scene mood into visual and lighting descriptions
- **Character Integration**: References locked character profiles for consistent visual descriptions

### 5. Emotional Beat Translation
- **Advanced Emotion Detection**: Identifies emotional content with intensity analysis and expanded emotion vocabulary
- **Detailed Visual Direction**: Translates emotions into comprehensive visual directions including facial expressions, body language, movement, and camera angles
- **Intensity-Based Scaling**: Adjusts visual directions based on emotional intensity (high, medium, low)
- **Character-Specific Directions**: Provides character-specific emotional directions with automatic character identification
- **Production-Ready Formatting**: Generates structured output for video production with scene setup, character directions, camera instructions, and lighting notes
- **Comprehensive Coverage**: Handles 12 emotion types (anger, sadness, joy, fear, surprise, disgust, love, contempt, pride, shame, excitement, calm)
- **Context-Aware Processing**: Considers scene context, mood, and time of day for appropriate lighting and atmosphere recommendations

## Core Methods

### `convertToScript(episode, characters, lockedProfiles)`
Main conversion method that transforms an episode into a complete screenplay.

**Parameters:**
- `episode`: Episode object containing scenes and content
- `characters`: Array of character objects with attributes and relationships
- `lockedProfiles`: Array of locked character profiles for consistency validation

**Returns:** Complete Screenplay object with formatted content, scenes, dialogue blocks, and scene descriptions

### `extractDialogue(content, characters)`
Extracts dialogue blocks from narrative content with speaker identification and emotional context.

**Parameters:**
- `content`: Raw narrative text content
- `characters`: Character array for speaker identification

**Returns:** Array of DialogueBlock objects with character IDs, text, emotions, and directions

### `generateSceneDescriptions(scene, characters)`
Creates detailed visual and action descriptions for scenes.

**Parameters:**
- `scene`: Scene object with content, setting, and character information
- `characters`: Character array for visual description generation

**Returns:** Array of SceneDescription objects with visual, action, and mood descriptions

### `validateCharacterVoiceConsistency(dialogueBlocks, characters, lockedProfiles)`
Validates that character dialogue maintains consistency with established character profiles.

**Parameters:**
- `dialogueBlocks`: Array of dialogue blocks to validate
- `characters`: Character definitions
- `lockedProfiles`: Locked character profiles with consistency rules

**Returns:** ValidationResult with errors and warnings for inconsistencies

### `translateEmotionalBeats(content, characters)`
Converts emotional content in narrative text to actionable visual directions.

**Parameters:**
- `content`: Narrative text containing emotional content
- `characters`: Character array for character-specific directions

**Returns:** Array of visual direction strings for emotional beats

## Screenplay Format

The Script Converter generates screenplays in a custom format optimized for AI video generation:

```
INT./EXT. COFFEE SHOP - MORNING

The scene takes place in Coffee Shop. Present characters: John (tall, brown hair, friendly demeanor), Sarah (medium height, blonde hair, warm smile). Balanced lighting and standard framing maintain visual clarity.

John walks into the coffee shop and sits down. He looks at Sarah and smiles.

JOHN
Good morning, Sarah.

SARAH
(cheerfully)
Oh, hello John! The usual?

JOHN
You know me too well.

---
```

## Integration Points

### With Episode Generator
- Receives Episode objects with structured scenes and content
- Maintains episode metadata and key events in screenplay format
- Preserves narrative continuity established by episode generation

### With Character System
- Uses locked character profiles for consistency validation
- References character attributes for visual descriptions
- Validates dialogue against character personality traits

### With Storyboard Creator
- Provides structured screenplay data for shot-by-shot generation
- Includes detailed scene descriptions for visual planning
- Supplies emotional directions for character animation

## Configuration Options

### Dialogue Pattern Recognition
The service supports multiple dialogue formats through configurable patterns:
- Standard double quotes: `"Hello there"`
- Single quotes: `'Hello there'`
- Japanese quotes: `「Hello there」`
- Narrative patterns: `said "Hello there"`

### Emotion Keywords
Comprehensive emotion detection using keyword mapping:
- **Anger**: angry, furious, rage, mad, irritated, annoyed
- **Sadness**: sad, crying, tears, sorrow, grief, melancholy
- **Joy**: happy, laughing, smile, joy, cheerful, delighted
- **Fear**: afraid, scared, terrified, anxious, worried, nervous
- **Surprise**: surprised, shocked, amazed, astonished, startled
- **Disgust**: disgusted, revolted, repulsed, sickened
- **Love**: love, affection, tender, caring, romantic, passionate

### Mood Visual Elements
Mood-based visual descriptions for atmospheric consistency:
- **Tense**: Harsh lighting, prominent shadows, atmosphere of unease
- **Romantic**: Soft warm lighting, gentle shadows, intimate framing
- **Dramatic**: Dynamic lighting, emotional intensity emphasis
- **Peaceful**: Natural even lighting, calm harmonious atmosphere
- **Mysterious**: Low-key lighting, deep shadows, air of mystery
- **Action**: High-contrast lighting, dynamic camera movement

## Error Handling

### Input Validation
- Validates episode structure and content
- Handles missing or malformed character data
- Gracefully processes empty or minimal dialogue scenes

### Character Consistency
- Reports voice inconsistencies with specific error codes
- Provides detailed feedback on personality mismatches
- Suggests corrections for dialogue that doesn't match character traits

### Format Validation
- Ensures proper screenplay formatting standards
- Validates scene heading format and structure
- Checks dialogue formatting and character name consistency

## Performance Considerations

### Optimization Features
- Efficient regex pattern matching for dialogue extraction
- Cached emotion and mood analysis results
- Streamlined character lookup and validation
- Minimal memory footprint for large episodes

### Scalability
- Handles episodes with multiple scenes efficiently
- Processes large amounts of dialogue without performance degradation
- Supports concurrent processing of multiple episodes
- Memory-efficient processing of character consistency validation

## Testing Coverage

### Unit Tests (15 test cases)
- Screenplay format conversion and structure validation
- Dialogue extraction with various quote patterns and speaker identification
- Scene description generation with visual and action elements
- Character voice consistency validation with personality matching
- Emotional beat translation to visual directions
- Edge case handling (empty episodes, malformed dialogue, special characters)

### Integration Tests (8 test cases)
- End-to-end episode to screenplay conversion
- Multi-episode character consistency maintenance
- Integration with Episode Generator and Character System
- Complex emotional scene processing with visual direction generation
- Performance testing with large episodes and multiple scenes
- Error handling for unknown characters and minimal dialogue

### Property-Based Testing
The component supports property-based testing for:
- **Screenplay format completeness**: All required elements present and properly formatted
- **Character voice consistency**: Dialogue patterns match character personalities
- **Emotional translation accuracy**: Emotional beats correctly translated to visual directions

## Usage Examples

### Basic Episode Conversion
```typescript
const screenplay = ScriptConverter.convertToScript(episode, characters, lockedProfiles)
console.log(screenplay.content) // Formatted screenplay text
```

### Dialogue Extraction
```typescript
const dialogueBlocks = ScriptConverter.extractDialogue(sceneContent, characters)
dialogueBlocks.forEach(block => {
  console.log(`${block.characterId}: ${block.text}`)
})
```

### Character Voice Validation
```typescript
const validation = ScriptConverter.validateCharacterVoiceConsistency(
  dialogueBlocks, 
  characters, 
  lockedProfiles
)
if (!validation.isValid) {
  validation.errors.forEach(error => console.log(error.message))
}
```

### Character Voice Maintenance
```typescript
// Maintain voice consistency across scenes
const maintainedDialogue = ScriptConverter.maintainCharacterVoiceConsistency(
  dialogueBlocks,
  characters,
  lockedProfiles
)

// Validate consistency across multiple episodes
const episodeDialogues = new Map([
  ['episode_1', episode1DialogueBlocks],
  ['episode_2', episode2DialogueBlocks]
])

const crossEpisodeValidation = ScriptConverter.validateCrossSceneVoiceConsistency(
  episodeDialogues,
  characters,
  lockedProfiles
)
```

### Emotional Beat Translation
```typescript
const directions = ScriptConverter.translateEmotionalBeats(content, characters)
directions.forEach(direction => console.log(direction))

// Format for production use
const sceneContext = {
  setting: 'Living Room',
  timeOfDay: 'EVENING',
  mood: 'tense'
}

const productionFormat = ScriptConverter.formatEmotionalDirectionsForProduction(
  directions, 
  sceneContext
)

console.log('Scene Setup:', productionFormat.sceneSetup)
console.log('Character Directions:', productionFormat.characterDirections)
console.log('Camera Instructions:', productionFormat.cameraInstructions)
console.log('Lighting Notes:', productionFormat.lightingNotes)
```

## Future Enhancements

### Planned Features
- Advanced dialogue style analysis and matching
- Support for additional screenplay formats (Fountain, Final Draft)
- Enhanced emotional direction generation with facial expression details
- Integration with voice synthesis for dialogue preview
- Advanced scene transition specifications

### Extensibility
- Pluggable dialogue pattern recognition
- Customizable emotion keyword mapping
- Configurable screenplay formatting templates
- Extensible character voice validation rules